<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Retro Raycaster - Victory & Tactics</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: white; font-family: 'Courier New', Courier, monospace; touch-action: none; }
        canvas { display: block; image-rendering: pixelated; width: 100vw; height: 100vh; }
        
        #menu, #achievements-menu {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        #achievements-menu { display: none; padding: 20px; }
        
        .btn {
            background: #a00; color: white; border: none; padding: 15px 30px;
            margin: 10px; font-size: 20px; cursor: pointer; font-family: inherit; transition: 0.3s;
        }
        .btn:hover { background: #f00; }
        .btn-support { background: #007bff; }
        .btn-support:hover { background: #0056b3; }

        #ui { 
            position: absolute; bottom: 20px; left: 20px; 
            pointer-events: none; text-shadow: 2px 2px 2px black; z-index: 10;
        }
        #health-bar { width: 200px; height: 20px; background: #300; border: 2px solid white; margin-bottom: 5px; }
        #health-fill { width: 100%; height: 100%; background: #f00; transition: width 0.3s; }
        
        #joystick-container {
            position: absolute; bottom: 40px; left: 40px;
            width: 120px; height: 120px; background: rgba(255,255,255,0.1);
            border-radius: 50%; display: none; touch-action: none; border: 2px solid rgba(255,255,255,0.3);
        }
        #joystick-stick {
            position: absolute; top: 50%; left: 50%;
            width: 50px; height: 50px; background: rgba(255,255,255,0.4);
            border-radius: 50%; transform: translate(-50%, -50%);
        }

        #shoot-btn, #reload-btn {
            position: absolute; border-radius: 50%; 
            background: rgba(255,0,0,0.5); border: 4px solid white;
            display: none; align-items: center; justify-content: center;
            user-select: none; z-index: 20; touch-action: none;
        }
        #shoot-btn { bottom: 40px; right: 40px; width: 100px; height: 100px; font-size: 40px; }
        #reload-btn { bottom: 150px; right: 55px; width: 70px; height: 70px; font-size: 25px; background: rgba(0,100,255,0.5); }

        #crosshair { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            color: lime; font-size: 24px; font-weight: bold; pointer-events: none;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∞—á–∏–≤–∫–µ */
        #achievement-popup {
            position: absolute; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 215, 0, 0.9); color: black; padding: 10px 20px;
            border-radius: 5px; font-weight: bold; transition: top 0.5s; z-index: 200;
        }

        .ach-list { text-align: left; max-width: 400px; margin-bottom: 20px; }
        .ach-item { margin: 10px 0; color: #888; }
        .ach-unlocked { color: #0f0; }
    </style>
</head>
<body>

    <div id="achievement-popup">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ!</div>

    <div id="menu">
        <h1>–£–±–µ–π —Ñ—É—Ä—Ä–∏: –ú–∏—Å—Å–∏—è –∑–∞—á–∏—Å—Ç–∫–∏</h1>
        <p>by: Karton820</p>
        <button class="btn" onclick="startGame('pc')">–ò–ì–†–ê–¢–¨ (–ü–ö)</button>
        <button class="btn" onclick="startGame('mobile')">–ò–ì–†–ê–¢–¨ (–¢–ï–õ–ï–§–û–ù)</button>
        <button class="btn" style="background:#555" onclick="toggleAchievements(true)">–î–û–°–¢–ò–ñ–ï–ù–ò–Ø</button>
        <button class="btn btn-support" onclick="window.open('https://www.donationalerts.com/r/karton820', '_blank')">–ü–û–î–î–ï–†–ñ–ê–¢–¨ –ê–í–¢–û–†–ê</button>
    </div>

    <div id="achievements-menu">
        <h2>–í–ê–®–ò –î–û–°–¢–ò–ñ–ï–ù–ò–Ø</h2>
        <div id="ach-container" class="ach-list"></div>
        <button class="btn" onclick="toggleAchievements(false)">–ù–ê–ó–ê–î</button>
    </div>

    <div id="joystick-container"><div id="joystick-stick"></div></div>
    <div id="shoot-btn">üî•</div>
    <div id="reload-btn">üîÑ</div>

    <canvas id="screen"></canvas>
    <div id="crosshair">+</div>
    <div id="ui">
        <div id="health-bar"><div id="health-fill"></div></div>
        <div id="ammo-display">AMMO: 10/30 | KILLS: 0/15</div>
    </div>

    <script>
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const screenWidth = 320, screenHeight = 200;
        canvas.width = screenWidth; canvas.height = screenHeight;

        const enemySprite = new Image(); enemySprite.src = 'furry.jpg';
        const itemSprite = new Image(); itemSprite.src = 'item.jpg';

        const map = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,2,0,0,1,0,2,0,2,0,1,1,0,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1],
            [1,0,1,1,1,1,0,1,0,1,1,0,1,1,1,1,0,1,0,1],
            [1,0,2,0,0,0,0,1,0,0,0,0,0,0,2,0,0,0,0,1],
            [1,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,1,1,0,1],
            [1,0,1,0,1,0,0,0,0,0,0,1,0,1,1,0,1,0,0,1],
            [1,0,0,0,1,0,2,0,2,0,0,1,0,0,0,0,1,0,2,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];
        const mapW = map[0].length, mapH = map.length;

        let player = { x: 2, y: 2, dir: 0, speed: 0.07, health: 100 };
        let joyPos = { x: 0, y: 0 };
        let ammo = 10, reserveAmmo = 30, gameRunning = false, isMobile = false;
        let enemiesKilled = 0;
        const killsToWin = 15;
        
        let enemies = [], items = [];
        let flash = 0, zBuffer = new Array(screenWidth), keys = {}, lastTouchX = null;

        // --- –°–ò–°–¢–ï–ú–ê –î–û–°–¢–ò–ñ–ï–ù–ò–ô ---
        let achievements = {
            first_kill: { name: "–ü–µ—Ä–≤—ã–π —Ñ—É—Ä—Ä–∏", desc: "–£–±–∏—Ç—å 1 –≤—Ä–∞–≥–∞", icon: "üíÄ", unlocked: false, goal: 1 },
            hunter: { name: "–°–ò–ì–ú–ê", desc: "–£–±–∏—Ç—å 10 –≤—Ä–∞–≥–æ–≤", icon: "üèπ", unlocked: false, goal: 10 },
            slayer: { name: "PozziPrime", desc: "–£–±–∏—Ç—å 15 –≤—Ä–∞–≥–æ–≤ (–ó–∞–≤–µ—Ä—à–∏—Ç—å –º–∏—Å—Å–∏—é)", icon: "üèÜ", unlocked: false, goal: 15 }
        };

        function checkAchievements() {
            for (let id in achievements) {
                let ach = achievements[id];
                if (!ach.unlocked && enemiesKilled >= ach.goal) {
                    ach.unlocked = true;
                    showAchievementPopup(ach.name);
                }
            }
        }

        function showAchievementPopup(name) {
            const pop = document.getElementById('achievement-popup');
            pop.innerText = "üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: " + name;
            pop.style.top = "20px";
            setTimeout(() => { pop.style.top = "-100px"; }, 3000);
        }

        function toggleAchievements(show) {
            document.getElementById('achievements-menu').style.display = show ? 'flex' : 'none';
            if (show) {
                const container = document.getElementById('ach-container');
                container.innerHTML = '';
                for (let id in achievements) {
                    let ach = achievements[id];
                    let div = document.createElement('div');
                    div.className = 'ach-item' + (ach.unlocked ? ' ach-unlocked' : '');
                    div.innerHTML = `${ach.icon} <b>${ach.name}</b><br><small>${ach.desc} ${ach.unlocked ? '(–í—ã–ø–æ–ª–Ω–µ–Ω–æ)' : '('+enemiesKilled+'/'+ach.goal+')'}</small>`;
                    container.appendChild(div);
                }
            }
        }

        function startGame(mode) {
            isMobile = mode === 'mobile';
            document.getElementById('menu').style.display = 'none';
            if (isMobile) {
                document.getElementById('joystick-container').style.display = 'block';
                document.getElementById('shoot-btn').style.display = 'flex';
                document.getElementById('reload-btn').style.display = 'flex';
                setupMobileControls();
            } else {
                canvas.onclick = () => canvas.requestPointerLock();
            }
            gameRunning = true;
            loop();
        }

        function setupMobileControls() {
            const joy = document.getElementById('joystick-container'), stick = document.getElementById('joystick-stick');
            window.addEventListener('touchstart', e => { for(let t of e.changedTouches) if (t.clientX > window.innerWidth / 2) lastTouchX = t.clientX; }, {passive: false});
            window.addEventListener('touchmove', e => {
                e.preventDefault();
                for(let t of e.touches) {
                    if (t.clientX < window.innerWidth/2) {
                        let rect = joy.getBoundingClientRect();
                        let dx = t.clientX - (rect.left + rect.width/2), dy = t.clientY - (rect.top + rect.height/2);
                        let dist = Math.min(60, Math.hypot(dx, dy)), angle = Math.atan2(dy, dx);
                        joyPos.x = (Math.cos(angle) * dist) / 60; joyPos.y = (Math.sin(angle) * dist) / 60;
                        stick.style.transform = `translate(calc(-50% + ${joyPos.x*60}px), calc(-50% + ${joyPos.y*60}px))`;
                    } else if (lastTouchX !== null) {
                        player.dir += (t.clientX - lastTouchX) * 0.007; lastTouchX = t.clientX;
                    }
                }
            }, {passive: false});
            window.addEventListener('touchend', e => { for(let t of e.changedTouches) if (t.clientX < window.innerWidth/2) { joyPos = {x:0, y:0}; stick.style.transform = 'translate(-50%, -50%)'; } else lastTouchX = null; });
            document.getElementById('shoot-btn').addEventListener('touchstart', e => { e.preventDefault(); shoot(); });
            document.getElementById('reload-btn').addEventListener('touchstart', e => { e.preventDefault(); reload(); });
        }

        window.addEventListener('keydown', e => { keys[e.code] = true; if (e.code === 'KeyR') reload(); });
        window.addEventListener('keyup', e => keys[e.code] = false);
        window.addEventListener('mousemove', e => { if (document.pointerLockElement === canvas) player.dir += e.movementX * 0.003; });
        window.addEventListener('mousedown', () => { if (gameRunning && !isMobile) shoot(); });

        function reload() {
            if (ammo === 10 || reserveAmmo <= 0) return;
            let toReload = Math.min(10 - ammo, reserveAmmo);
            ammo += toReload; reserveAmmo -= toReload; updateUI();
        }

        function shoot() {
            if (ammo <= 0 || player.health <= 0) return;
            ammo--; flash = 5;
            let nearestEnemy = null, minDist = 10;
            enemies.forEach(en => {
                if (!en.alive) return;
                let dx = en.x - player.x, dy = en.y - player.y, dist = Math.sqrt(dx*dx + dy*dy);
                let angle = Math.atan2(dy, dx) - player.dir;
                while (angle < -Math.PI) angle += Math.PI * 2;
                while (angle > Math.PI) angle -= Math.PI * 2;
                if (Math.abs(angle) < 0.15 && dist < minDist && dist < getWallDist(angle + player.dir)) {
                    minDist = dist; nearestEnemy = en;
                }
            });
            if (nearestEnemy) {
                nearestEnemy.alive = false; enemiesKilled++;
                checkAchievements();
                if (Math.random() > 0.7) items.push({x: nearestEnemy.x, y: nearestEnemy.y, type: Math.random() > 0.5 ? 'ammo' : 'medkit', collected: false});
            }
            updateUI();
        }

        function getWallDist(a) {
            let d = 0; while (d < 15) { d += 0.1; let tx = Math.floor(player.x + Math.cos(a)*d), ty = Math.floor(player.y + Math.sin(a)*d); if (tx<0 || tx>=mapW || ty<0 || ty>=mapH || map[ty][tx] > 0) return d; }
            return 15;
        }

        function updateUI() {
            document.getElementById('ammo-display').innerText = `AMMO: ${ammo}/${reserveAmmo} | KILLS: ${enemiesKilled}/${killsToWin}`;
            document.getElementById('health-fill').style.width = player.health + "%";
            if (enemiesKilled >= killsToWin) { gameRunning = false; alert("–û–¢–õ–ò–ß–ù–û! –¢—ã —Ç–µ–ø–µ—Ä—å Pozziprime."); location.reload(); }
            if (player.health <= 0) { alert("–í–´ –ü–û–ì–ò–ë–õ–ò"); location.reload(); }
        }

        function update() {
            let mx = 0, my = 0;
            if (isMobile) {
                mx = (-joyPos.y * Math.cos(player.dir) + joyPos.x * Math.cos(player.dir + Math.PI/2)) * player.speed;
                my = (-joyPos.y * Math.sin(player.dir) + joyPos.x * Math.sin(player.dir + Math.PI/2)) * player.speed;
            } else {
                if (keys['KeyW']) { mx += Math.cos(player.dir); my += Math.sin(player.dir); }
                if (keys['KeyS']) { mx -= Math.cos(player.dir); my -= Math.sin(player.dir); }
                if (keys['KeyA']) { mx += Math.cos(player.dir - Math.PI/2); my += Math.sin(player.dir - Math.PI/2); }
                if (keys['KeyD']) { mx += Math.cos(player.dir + Math.PI/2); my += Math.sin(player.dir + Math.PI/2); }
                let mag = Math.sqrt(mx*mx + my*my); if (mag > 0) { mx = (mx/mag)*player.speed; my = (my/mag)*player.speed; }
            }
            if (map[Math.floor(player.y)][Math.floor(player.x + mx*2)] === 0) player.x += mx;
            if (map[Math.floor(player.y + my*2)][Math.floor(player.x)] === 0) player.y += my;

            items.forEach(it => { if(!it.collected && Math.hypot(player.x-it.x, player.y-it.y) < 0.5) { 
                it.collected = true; if(it.type==='medkit') player.health = Math.min(100, player.health+30); else reserveAmmo+=20; updateUI();
            }});

            enemies.forEach(en => {
                if (!en.alive) return;
                let dx = player.x - en.x, dy = player.y - en.y, d = Math.sqrt(dx*dx + dy*dy);
                if (d < 0.6) { player.health -= 0.5; updateUI(); }
                else if (d < 8) { en.x += (dx/d)*0.025; en.y += (dy/d)*0.025; }
            });

            if (Math.random() < 0.015 && enemies.filter(e=>e.alive).length < 6) {
                let rx = Math.random() * (mapW-2) + 1, ry = Math.random() * (mapH-2) + 1;
                if (map[Math.floor(ry)][Math.floor(rx)] === 0 && Math.hypot(player.x-rx, player.y-ry) > 3) enemies.push({x: rx, y: ry, alive: true});
            }
            if (flash > 0) flash--;
        }

        function draw() {
            ctx.fillStyle = "#203"; ctx.fillRect(0,0,screenWidth,screenHeight/2);
            ctx.fillStyle = "#111"; ctx.fillRect(0,screenHeight/2,screenWidth,screenHeight/2);
            for (let i = 0; i < screenWidth; i++) {
                let angle = (player.dir - 0.5) + (i / screenWidth), d = 0, hit = 0;
                while (hit === 0 && d < 15) {
                    d += 0.05;
                    let tx = Math.floor(player.x + Math.cos(angle)*d), ty = Math.floor(player.y + Math.sin(angle)*d);
                    if (tx < 0 || tx >= mapW || ty < 0 || ty >= mapH) { hit = 1; d = 15; } else hit = map[ty][tx];
                }
                zBuffer[i] = d * Math.cos(angle - player.dir);
                let h = screenHeight / zBuffer[i], c = 180 / (1 + d * 0.25);
                ctx.fillStyle = hit === 1 ? `rgb(${c}, ${c*0.3}, ${c*0.3})` : `rgb(${c*0.4}, ${c*0.4}, ${c*0.8})`;
                ctx.fillRect(i, screenHeight/2 - h/2, 1, h);
            }
            let sprites = [];
            enemies.forEach(e => { if(e.alive) sprites.push({...e, type: 'enemy'})});
            items.forEach(it => { if(!it.collected) sprites.push({...it, type: it.type})});
            sprites.sort((a,b) => Math.hypot(b.x-player.x, b.y-player.y) - Math.hypot(a.x-player.x, a.y-player.y));
            sprites.forEach(s => {
                let dx = s.x - player.x, dy = s.y - player.y, dist = Math.sqrt(dx*dx+dy*dy);
                let ang = Math.atan2(dy, dx) - player.dir;
                while (ang < -Math.PI) ang += Math.PI*2; while (ang > Math.PI) ang -= Math.PI*2;
                if (Math.abs(ang) < 1) {
                    let sx = (ang + 0.5) * screenWidth, h = screenHeight / dist, w = h;
                    if (dist > 0.2 && zBuffer[Math.floor(sx)] > dist) {
                        try { ctx.drawImage(s.type === 'enemy' ? enemySprite : itemSprite, sx-w/2, screenHeight/2-h/2, w, h); }
                        catch(e) { ctx.fillStyle = "red"; ctx.fillRect(sx-w/4, screenHeight/2, w/2, h/2); }
                    }
                }
            });
            if (flash > 0) { ctx.fillStyle = `rgba(255,255,200,${flash*0.1})`; ctx.fillRect(0,0,screenWidth,screenHeight); }
        }

        function loop() { if (gameRunning) { update(); draw(); } requestAnimationFrame(loop); }
    </script>
</body>
</html>
