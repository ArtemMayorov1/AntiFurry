<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>KILL FURRY</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: white; font-family: 'Courier New', Courier, monospace; touch-action: none; }
        canvas { display: block; image-rendering: pixelated; width: 100vw; height: 100vh; }
        
        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
            text-align: center;
        }

        #menu, #weapon-menu, #controls-pc, #controls-mobile, #achievements-menu, #game-over, #victory-screen { display: none; }
        #menu { display: flex; }
        
        .btn {
            background: #a00; color: white; border: none; padding: 12px 25px;
            margin: 8px; font-size: 18px; cursor: pointer; font-family: inherit; transition: 0.3s;
        }
        .btn:hover { background: #f00; scale: 1.05; }
        .btn-weapon { background: #444; width: 250px; }
        .selected-wep { border: 2px solid lime; background: #222; }

        #ui { 
            position: absolute; bottom: 20px; left: 20px; 
            pointer-events: none; text-shadow: 2px 2px 2px black; z-index: 10;
        }
        #health-bar { width: 200px; height: 20px; background: #300; border: 2px solid white; margin-bottom: 5px; }
        #health-fill { width: 100%; height: 100%; background: #f00; transition: width 0.3s; }
        
        #joystick-container {
            position: absolute; bottom: 40px; left: 40px;
            width: 120px; height: 120px; background: rgba(255,255,255,0.1);
            border-radius: 50%; display: none; touch-action: none; border: 2px solid rgba(255,255,255,0.3);
        }
        #joystick-stick {
            position: absolute; top: 50%; left: 50%;
            width: 50px; height: 50px; background: rgba(255,255,255,0.4);
            border-radius: 50%; transform: translate(-50%, -50%);
        }

        #shoot-btn, #reload-btn {
            position: absolute; border-radius: 50%; 
            background: rgba(255,0,0,0.5); border: 4px solid white;
            display: none; align-items: center; justify-content: center;
            user-select: none; z-index: 20; touch-action: none;
        }
        #shoot-btn { bottom: 40px; right: 40px; width: 100px; height: 100px; font-size: 40px; }
        #reload-btn { bottom: 150px; right: 55px; width: 70px; height: 70px; font-size: 25px; background: rgba(0,100,255,0.5); }

        #crosshair { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            color: lime; font-size: 24px; font-weight: bold; pointer-events: none;
        }
        #blood-overlay {
            position: absolute; inset: 0; background: radial-gradient(circle, transparent 30%, rgba(150,0,0,0.6) 100%);
            pointer-events: none; opacity: 0; transition: opacity 0.1s; z-index: 5;
        }

        #ach-notification {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9); color: #0f0; padding: 15px 30px;
            border-radius: 5px; font-weight: bold; display: none; z-index: 200;
            border: 2px solid #0f0; box-shadow: 0 0 15px rgba(0,255,0,0.5);
            pointer-events: none; animation: slideDown 0.5s ease;
        }
        @keyframes slideDown { from { top: -100px; } to { top: 20px; } }
    </style>
</head>
<body>

    <div id="blood-overlay"></div>
    <div id="ach-notification"></div>

    <div id="menu" class="overlay">
        <h1>>–£–ë–ï–ô –§–£–†–†–ò<</h1>
        <p>by Karton820: TT</p>
        <button class="btn" onclick="showScreen('weapon-menu')">–ò–ì–†–ê–¢–¨</button>
        <button class="btn" style="background:#555" onclick="toggleAchievements(true)">–î–û–°–¢–ò–ñ–ï–ù–ò–Ø</button>
        <button class="btn" style="background:#007bff" onclick="window.open('https://www.donationalerts.com/r/karton820', '_blank')">–ü–û–î–î–ï–†–ñ–ê–¢–¨</button>
    </div>

    <div id="weapon-menu" class="overlay">
        <h2>–í–´–ë–ï–†–ò–¢–ï –û–†–£–ñ–ò–ï</h2>
        <button id="wep0" class="btn btn-weapon selected-wep" onclick="selectWeapon(0)">–ü–ò–°–¢–û–õ–ï–¢</button>
        <button id="wep1" class="btn btn-weapon" onclick="selectWeapon(1)">–î–†–û–ë–û–í–ò–ö</button>
        <button id="wep2" class="btn btn-weapon" onclick="selectWeapon(2)">–ê–í–¢–û–ú–ê–¢</button>
        <button class="btn" onclick="showScreen('controls-pc')">–ü–ö</button>
        <button class="btn" onclick="showScreen('controls-mobile')">–¢–ï–õ–ï–§–û–ù</button>
    </div>

    <div id="controls-pc" class="overlay">
        <h2>–£–ü–†–ê–í–õ–ï–ù–ò–ï (–ü–ö)</h2>
        <p>WASD - –ë–µ–≥, –ú—ã—à—å - –û–≥–æ–Ω—å, R - –ó–∞—Ä—è–¥–∫–∞</p>
        <button class="btn" onclick="startGame('pc')">–í –ë–û–ô!</button>
    </div>

    <div id="controls-mobile" class="overlay">
        <h2>–£–ü–†–ê–í–õ–ï–ù–ò–ï (MOBILE)</h2>
        <p>–õ–µ–≤—ã–π —Å—Ç–∏–∫ - –•–æ–¥—å–±–∞, –ü—Ä–∞–≤—ã–π —ç–∫—Ä–∞–Ω - –û–±–∑–æ—Ä</p>
        <button class="btn" onclick="startGame('mobile')">–í –ë–û–ô!</button>
    </div>

    <div id="achievements-menu" class="overlay">
        <h2>–î–û–°–¢–ò–ñ–ï–ù–ò–Ø</h2>
        <div id="ach-container" style="text-align: left; width: 90%; max-width: 500px; margin-bottom: 20px; overflow-y: auto; max-height: 65vh; background: #111; padding: 10px; border: 1px solid #444;"></div>
        <button class="btn" onclick="showScreen('menu')">–í –ú–ï–ù–Æ</button>
    </div>

    <div id="game-over" class="overlay" style="background: rgba(50, 0, 0, 0.9);">
        <h1 style="color:red; font-size:60px;">–¢–´ –ü–û–ì–ò–ë</h1>
        <button class="btn" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
    </div>

    <div id="victory-screen" class="overlay" style="background: rgba(0, 50, 0, 0.9);">
        <h1 style="color:lime;">–ó–ê–ß–ò–°–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!</h1>
        <button class="btn" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
    </div>

    <div id="joystick-container"><div id="joystick-stick"></div></div>
    <div id="shoot-btn">üî•</div>
    <div id="reload-btn">üîÑ</div>

    <canvas id="screen"></canvas>
    <div id="crosshair">+</div>
    <div id="ui">
        <div id="timer-display">TIME: 03:00</div>
        <div id="health-bar"><div id="health-fill"></div></div>
        <div id="ammo-display">AMMO: 10/30 | KILLS: 0/15</div>
    </div>

    <script>
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const screenWidth = 320, screenHeight = 200;
        canvas.width = screenWidth; canvas.height = screenHeight;

        const enemySprite = new Image(); enemySprite.src = 'furry.png';
        const itemSprite = new Image(); itemSprite.src = 'item.jpg';

        // –ó–≤—É–∫ —Å—Ç—Ä–µ–ª—å–±—ã
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playShootSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        const map = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,2,0,0,1,0,2,0,2,0,1,1,0,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1],
            [1,0,1,1,1,1,0,1,0,1,1,0,1,1,1,1,0,1,0,1],
            [1,0,2,0,0,0,0,1,0,0,0,0,0,0,2,0,0,0,0,1],
            [1,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,1,1,0,1],
            [1,0,1,0,1,0,0,0,0,0,0,1,0,1,1,0,1,0,0,1],
            [1,0,0,0,1,0,2,0,2,0,0,1,0,0,0,0,1,0,2,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];
        const mapW = map[0].length, mapH = map.length;

        const weaponTypes = [
            { name: "–ü–∏—Å—Ç–æ–ª–µ—Ç", clip: 10, reserve: 60, range: 10, spread: 0.1, pack: 10 },
            { name: "–î—Ä–æ–±–æ–≤–∏–∫", clip: 4, reserve: 24, range: 4, spread: 0.4, pack: 4 },
            { name: "–ê–≤—Ç–æ–º–∞—Ç", clip: 30, reserve: 90, range: 8, spread: 0.2, pack: 30 }
        ];
        
        let currentWepIdx = 0, ammo = 10, reserveAmmo = 60, shotsInMag = 0;
        let player = { x: 2, y: 2, dir: 0, speed: 0.07, health: 100 };
        let gameRunning = false, isMobile = false, enemiesKilled = 0, timeLeft = 180;
        const killsToWin = 15;
        
        let enemies = [], items = [], deadBodies = [], particles = [], flash = 0, itemsCollectedCount = 0;
        let zBuffer = new Array(screenWidth), keys = {}, lastTouchX = null, joyPos = { x: 0, y: 0 };
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞—á–∏–≤–æ–∫
        let killsWithoutDamage = 0;
        let killsInMag = 0;
        let pacifistTimer = 0;
        let medkitStreak = 0;

        let achievements = {
            k1: { name: "–ü–µ—Ä–≤–∞—è –∫—Ä–æ–≤—å", desc: "–£–±–∏—Ç—å 1 —Ñ—É—Ä—Ä–∏", icon: "üíÄ", goal: 1, current: 0, unlocked: false },
            k10: { name: "–û—Ö–æ—Ç–Ω–∏–∫", desc: "–£–±–∏—Ç—å 10 —Ñ—É—Ä—Ä–∏", icon: "üèπ", goal: 10, current: 0, unlocked: false },
            k50: { name: "–ú—è—Å–Ω–∏–∫", desc: "–£–±–∏—Ç—å 50 —Ñ—É—Ä—Ä–∏", icon: "‚öîÔ∏è", goal: 50, current: 0, unlocked: false },
            win1: { name: "–í—ã–∂–∏–≤—à–∏–π", desc: "–ü—Ä–æ–π—Ç–∏ –∏–≥—Ä—É 1 —Ä–∞–∑", icon: "üèÜ", goal: 1, current: 0, unlocked: false },
            win5: { name: "–ß–µ–º–ø–∏–æ–Ω", desc: "–ü—Ä–æ–π—Ç–∏ –∏–≥—Ä—É 5 —Ä–∞–∑", icon: "ü•á", goal: 5, current: 0, unlocked: false },
            fast: { name: "–°–ø–∏–¥—Ä–∞–Ω–Ω–µ—Ä", desc: "–£–±–∏—Ç—å —Ñ—É—Ä—Ä–∏ –≤ –ø–µ—Ä–≤—ã–µ 5 —Å–µ–∫—É–Ω–¥", icon: "‚ö°", goal: 1, current: 0, unlocked: false },
            no_dmg: { name: "–ù–µ–ø—Ä–∏–∫–∞—Å–∞–µ–º—ã–π", desc: "–£–±–∏—Ç—å 5 —Ñ—É—Ä—Ä–∏, –Ω–µ –ø–æ–ª—É—á–∞—è —É—Ä–æ–Ω–∞", icon: "üõ°Ô∏è", goal: 5, current: 0, unlocked: false },
            low_hp: { name: "–ù–∞ –≤–æ–ª–æ—Å–∫–µ", desc: "–£–±–∏—Ç—å –≤—Ä–∞–≥–∞, –∏–º–µ—è –º–µ–Ω—å—à–µ 10% –∑–¥–æ—Ä–æ–≤—å—è", icon: "ü©∏", goal: 1, current: 0, unlocked: false },
            empty: { name: "–î–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ", desc: "–í—ã—Å—Ç—Ä–µ–ª–∏—Ç—å –≤—Å—é –æ–±–æ–π–º—É", icon: "üî´", goal: 1, current: 0, unlocked: false },
            pistol_fan: { name: "–ö–ª–∞—Å—Å–∏–∫–∞", desc: "–ü–æ–±–µ–¥–∏—Ç—å —Å –ø–∏—Å—Ç–æ–ª–µ—Ç–æ–º", icon: "üéØ", goal: 1, current: 0, unlocked: false },
            rich: { name: "–ó–∞–ø–∞—Å–ª–∏–≤—ã–π", desc: "–°–æ–±—Ä–∞—Ç—å 100 –ø–∞—Ç—Ä–æ–Ω–æ–≤", icon: "üì¶", goal: 100, current: 0, unlocked: false },
            medic: { name: "–í—Ä–∞—á—É, –∏—Å—Ü–µ–ª–∏—Å—è —Å–∞–º", desc: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ø—Ç–µ—á–∫—É –ø—Ä–∏ 100 HP", icon: "üíä", goal: 1, current: 0, unlocked: false },
            explorer: { name: "–¢—É—Ä–∏—Å—Ç", desc: "–ü—Ä–æ–π—Ç–∏ 500 —à–∞–≥–æ–≤", icon: "üë£", goal: 500, current: 0, unlocked: false },
            ninja: { name: "–ù–∏–Ω–¥–∑—è", desc: "–ü–æ–¥–æ–π—Ç–∏ –∫ –≤—Ä–∞–≥—É –≤–ø–ª–æ—Ç–Ω—É—é", icon: "üë§", goal: 1, current: 0, unlocked: false },
            terminator: { name: "–¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä", desc: "100 —É–±–∏–π—Å—Ç–≤ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è", icon: "ü¶æ", goal: 100, current: 0, unlocked: false },
            pacifist: { name: "–ü–∞—Ü–∏—Ñ–∏—Å—Ç?", desc: "–ü—Ä–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è 30 —Å–µ–∫—É–Ω–¥ –±–µ–∑ –≤—ã—Å—Ç—Ä–µ–ª–æ–≤", icon: "üïäÔ∏è", goal: 30, current: 0, unlocked: false },
            lucky: { name: "–í–µ–∑—É–Ω—á–∏–∫", desc: "–ù–∞–π—Ç–∏ 3 –∞–ø—Ç–µ—á–∫–∏ –ø–æ–¥—Ä—è–¥", icon: "üçÄ", goal: 3, current: 0, unlocked: false },
            sniper: { name: "–°–Ω–∞–π–ø–µ—Ä", desc: "–£–±–∏—Ç—å –≤—Ä–∞–≥–∞ –Ω–∞ –º–∞–∫—Å. –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏", icon: "üëÅÔ∏è", goal: 1, current: 0, unlocked: false },
            collector: { name: "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä", desc: "–°–æ–±—Ä–∞—Ç—å 10 –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∑–∞ –∏–≥—Ä—É", icon: "üíé", goal: 10, current: 0, unlocked: false },
            god: { name: "–ü–û–ó–ó–ò –ü–†–ê–ô–ú", desc: "–í—ã–ø–æ–ª–Ω–∏—Ç—å 15 —É–±–∏–π—Å—Ç–≤ –±–µ–∑ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏", icon: "üåü", goal: 15, current: 0, unlocked: false }
        };

        function saveAch() { localStorage.setItem('kf_ach_v2', JSON.stringify(achievements)); }
        function loadAch() {
            let s = localStorage.getItem('kf_ach_v2');
            if(s) {
                let p = JSON.parse(s);
                for(let k in p) if(achievements[k]) { 
                    achievements[k].unlocked = p[k].unlocked; 
                    achievements[k].current = p[k].current; 
                }
            }
        }
        loadAch();

        function unlockAch(id) {
            let a = achievements[id];
            if(!a.unlocked && a.current >= a.goal) {
                a.unlocked = true;
                let n = document.getElementById('ach-notification');
                n.innerHTML = `üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–ï:<br>${a.name}`;
                n.style.display = 'block';
                setTimeout(() => n.style.display = 'none', 3000);
                saveAch();
            }
        }

        function startGame(mode) {
            isMobile = mode === 'mobile';
            showScreen('none');
            player = { x: 2, y: 2, dir: 0, speed: 0.07, health: 100 };
            enemies = []; items = []; deadBodies = []; particles = [];
            enemiesKilled = 0; timeLeft = 180; shotsInMag = 0; itemsCollectedCount = 0;
            killsWithoutDamage = 0; pacifistTimer = 0; killsInMag = 0; medkitStreak = 0;
            if(isMobile) {
                document.getElementById('joystick-container').style.display = 'block';
                document.getElementById('shoot-btn').style.display = 'flex';
                document.getElementById('reload-btn').style.display = 'flex';
                setupMobileControls();
            } else canvas.requestPointerLock();
            gameRunning = true;
            updateUI();
            loop();
        }

        function shoot() {
            if (ammo <= 0 || player.health <= 0 || !gameRunning) return;
            playShootSound();
            ammo--; shotsInMag++;
            pacifistTimer = 0; // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ –ø–∞—Ü–∏—Ñ–∏—Å—Ç–∞
            flash = 5;
            
            if(ammo === 0) { achievements.empty.current = 1; unlockAch('empty'); }

            let wep = weaponTypes[currentWepIdx];
            enemies.forEach(en => {
                if (!en.alive) return;
                let dx = en.x - player.x, dy = en.y - player.y, dist = Math.sqrt(dx*dx + dy*dy);
                let angle = Math.atan2(dy, dx) - player.dir;
                while (angle < -Math.PI) angle += Math.PI * 2;
                while (angle > Math.PI) angle -= Math.PI * 2;
                
                if (Math.abs(angle) < wep.spread && dist < wep.range) {
                    en.alive = false; enemiesKilled++;
                    killsWithoutDamage++;
                    killsInMag++;

                    // –ê—á–∏–≤–∫–∞: –°–ø–∏–¥—Ä–∞–Ω–Ω–µ—Ä (–≤ –ø–µ—Ä–≤—ã–µ 5 —Å–µ–∫ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞)
                    if(timeLeft > 175) { achievements.fast.current = 1; unlockAch('fast'); }
                    
                    // –ê—á–∏–≤–∫–∞: –ù–µ–ø—Ä–∏–∫–∞—Å–∞–µ–º—ã–π
                    achievements.no_dmg.current = killsWithoutDamage; unlockAch('no_dmg');

                    // –ê—á–∏–≤–∫–∞: –ü–æ–∑–∑–∏ –ü—Ä–∞–π–º (–±–µ–∑ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏)
                    achievements.god.current = killsInMag; unlockAch('god');

                    for(let i=0; i<8; i++) {
                        particles.push({
                            x: en.x, y: en.y, 
                            vx: (Math.random()-0.5)*0.1, vy: (Math.random()-0.5)*0.1, 
                            life: 40 + Math.random()*30
                        });
                    }
                    deadBodies.push({x: en.x, y: en.y, opacity: 1});
                    
                    achievements.k1.current++; unlockAch('k1');
                    achievements.k10.current = enemiesKilled; unlockAch('k10');
                    achievements.k50.current++; unlockAch('k50');
                    achievements.terminator.current++; unlockAch('terminator');
                    if(player.health < 10) { achievements.low_hp.current = 1; unlockAch('low_hp'); }
                    if(dist > 7) { achievements.sniper.current = 1; unlockAch('sniper'); }
                    
                    if (Math.random() > 0.5) {
                        items.push({
                            x: en.x, 
                            y: en.y, 
                            type: Math.random() > 0.5 ? 'ammo' : 'medkit', 
                            collected: false
                        });
                    }
                }
            });
            updateUI();
        }

        function update() {
            if (!gameRunning) return;
            if (timeLeft > 0) timeLeft -= 1/60;

            // –ê—á–∏–≤–∫–∞: –ü–∞—Ü–∏—Ñ–∏—Å—Ç
            pacifistTimer += 1/60;
            achievements.pacifist.current = pacifistTimer;
            unlockAch('pacifist');

            let mx = 0, my = 0;
            if (isMobile) {
                mx = (-joyPos.y * Math.cos(player.dir) + joyPos.x * Math.cos(player.dir + Math.PI/2)) * player.speed;
                my = (-joyPos.y * Math.sin(player.dir) + joyPos.x * Math.sin(player.dir + Math.PI/2)) * player.speed;
            } else {
                if (keys['KeyW']) { mx += Math.cos(player.dir); my += Math.sin(player.dir); }
                if (keys['KeyS']) { mx -= Math.cos(player.dir); my -= Math.sin(player.dir); }
                if (keys['KeyA']) { mx += Math.cos(player.dir - Math.PI/2); my += Math.sin(player.dir - Math.PI/2); }
                if (keys['KeyD']) { mx += Math.cos(player.dir + Math.PI/2); my += Math.sin(player.dir + Math.PI/2); }
                let mag = Math.sqrt(mx*mx+my*my); if(mag>0) { mx=(mx/mag)*player.speed; my=(my/mag)*player.speed; }
            }
            
            if (map[Math.floor(player.y)][Math.floor(player.x + mx*2)] === 0) player.x += mx;
            if (map[Math.floor(player.y + my*2)][Math.floor(player.x)] === 0) player.y += my;
            
            if(mx !== 0 || my !== 0) { achievements.explorer.current += 0.1; unlockAch('explorer'); }

            items.forEach(it => {
                if(!it.collected) {
                    let d = Math.hypot(it.x - player.x, it.y - player.y);
                    if(d < 0.5) {
                        it.collected = true;
                        itemsCollectedCount++;
                        achievements.collector.current = itemsCollectedCount;
                        unlockAch('collector');
                        
                        if(it.type === 'medkit') {
                            medkitStreak++;
                            achievements.lucky.current = medkitStreak; unlockAch('lucky');
                            if(player.health >= 100) { achievements.medic.current = 1; unlockAch('medic'); }
                            player.health = Math.min(100, player.health + 30);
                        } else {
                            medkitStreak = 0; // –°–±—Ä–æ—Å —Å–µ—Ä–∏–∏ –∞–ø—Ç–µ—á–µ–∫
                            let add = weaponTypes[currentWepIdx].pack;
                            reserveAmmo += add;
                            achievements.rich.current += add; unlockAch('rich');
                        }
                        updateUI();
                    }
                }
            });

            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life--;
                if(p.life <= 0) particles.splice(i, 1);
            });
            deadBodies.forEach(b => { if(b.opacity > 0) b.opacity -= 0.001; });

            enemies.forEach(en => {
                if (!en.alive) return;
                let dx = player.x - en.x, dy = player.y - en.y, d = Math.sqrt(dx*dx + dy*dy);
                if (d < 0.6) { 
                    player.health -= 0.5; 
                    killsWithoutDamage = 0; // –°–±—Ä–æ—Å —Å–µ—Ä–∏–∏ –±–µ–∑ —É—Ä–æ–Ω–∞
                    updateUI(); 
                }
                else if (d < 8) {
                    let vx = (dx/d)*0.02, vy = (dy/d)*0.02;
                    if(map[Math.floor(en.y)][Math.floor(en.x + vx*3)] === 0) en.x += vx;
                    if(map[Math.floor(en.y + vy*3)][Math.floor(en.x)] === 0) en.y += vy;
                    if(d < 1) { achievements.ninja.current = 1; unlockAch('ninja'); }
                }
            });

            if (Math.random() < 0.02 && enemies.filter(e=>e.alive).length < 6) {
                let rx = Math.random()*(mapW-2)+1, ry = Math.random()*(mapH-2)+1;
                if(map[Math.floor(ry)][Math.floor(rx)] === 0) enemies.push({x:rx, y:ry, alive:true});
            }
            
            if(flash > 0) flash--;
        }

        function draw() {
            ctx.fillStyle = "#101"; ctx.fillRect(0,0,screenWidth,screenHeight/2);
            ctx.fillStyle = "#111"; ctx.fillRect(0,screenHeight/2,screenWidth,screenHeight/2);
            
            for (let i = 0; i < screenWidth; i++) {
                let angle = (player.dir - 0.5) + (i / screenWidth), d = 0, hit = 0;
                while (hit === 0 && d < 15) {
                    d += 0.05;
                    let tx = Math.floor(player.x + Math.cos(angle)*d), ty = Math.floor(player.y + Math.sin(angle)*d);
                    if (tx < 0 || tx >= mapW || ty < 0 || ty >= mapH) { hit = 1; d = 15; } else hit = map[ty][tx];
                }
                zBuffer[i] = d * Math.cos(angle - player.dir);
                let h = screenHeight / zBuffer[i], c = 160 / (1 + d * 0.25);
                ctx.fillStyle = hit === 1 ? `rgb(${c},0,0)` : `rgb(40,40,${c})`;
                ctx.fillRect(i, screenHeight/2 - h/2, 1, h);
            }
            
            let sprites = [];
            deadBodies.forEach(b => { if(b.opacity > 0.1) sprites.push({x:b.x, y:b.y, type:'blood', op:b.opacity})});
            particles.forEach(p => sprites.push({x:p.x, y:p.y, type:'gore'}));
            enemies.forEach(e => { if(e.alive) sprites.push({...e, type:'enemy'})});
            items.forEach(it => { if(!it.collected) sprites.push({...it, type:it.type})});
            
            sprites.sort((a,b) => Math.hypot(b.x-player.x, b.y-player.y) - Math.hypot(a.x-player.x, a.y-player.y));
            
            sprites.forEach(s => {
                let dx = s.x - player.x, dy = s.y - player.y, dist = Math.sqrt(dx*dx+dy*dy);
                let ang = Math.atan2(dy, dx) - player.dir;
                while (ang < -Math.PI) ang += Math.PI*2; 
                while (ang > Math.PI) ang -= Math.PI*2;
                
                if (Math.abs(ang) < 0.8 && dist > 0.1 && dist < 15) {
                    let sx = (ang / 1 + 0.5) * screenWidth;
                    if (zBuffer[Math.floor(sx)] > dist) {
                        let h = screenHeight / dist, w = h * 0.5;
                        if(s.type === 'blood') {
                            ctx.fillStyle = `rgba(100,0,0,${s.op})`;
                            ctx.fillRect(sx-w, screenHeight/2+h/4, w*2, h/10);
                        } else if(s.type === 'gore') {
                            ctx.fillStyle = "#f00"; ctx.fillRect(sx, screenHeight/2+Math.random()*20, 2, 2);
                        } else if(s.type === 'enemy') {
                            try { ctx.drawImage(enemySprite, sx-w/2, screenHeight/2-h/2, w, h); }
                            catch(e) { ctx.fillStyle = 'red'; ctx.fillRect(sx-w/2, screenHeight/2-h/2, w, h); }
                        } else {
                            ctx.fillStyle = s.type === 'medkit' ? '#fff' : '#ff0';
                            ctx.fillRect(sx-w/4, screenHeight/2, w/2, h/2);
                            ctx.fillStyle = s.type === 'medkit' ? '#f00' : '#000';
                            ctx.fillRect(sx-2, screenHeight/2 + h/4 - 2, 4, 4);
                        }
                    }
                }
            });
            if (flash > 0) { ctx.fillStyle = `rgba(255,255,255,${flash*0.15})`; ctx.fillRect(0,0,screenWidth,screenHeight); }
        }

        function showScreen(id) {
            document.querySelectorAll('.overlay').forEach(s => s.style.display = 'none');
            if(id !== 'none') document.getElementById(id).style.display = 'flex';
        }

        function toggleAchievements(show) {
            if(show) {
                showScreen('achievements-menu');
                let cont = document.getElementById('ach-container');
                cont.innerHTML = '';
                for(let id in achievements) {
                    let a = achievements[id];
                    cont.innerHTML += `<div style="padding:5px; border-bottom:1px solid #222; color:${a.unlocked?'#0f0':'#555'}">
                        ${a.icon} <b>${a.name}</b> [${Math.floor(a.current)}/${a.goal}]<br>
                        <small>${a.desc}</small>
                    </div>`;
                }
            } else showScreen('menu');
        }

        function selectWeapon(idx) {
            currentWepIdx = idx;
            document.querySelectorAll('.btn-weapon').forEach((b, i) => b.classList.toggle('selected-wep', i === idx));
            ammo = weaponTypes[idx].clip; reserveAmmo = weaponTypes[idx].reserve;
            shotsInMag = 0; killsInMag = 0;
        }

        function reload() {
            let m = weaponTypes[currentWepIdx].clip;
            if(ammo < m && reserveAmmo > 0) {
                let take = Math.min(m - ammo, reserveAmmo);
                ammo += take; reserveAmmo -= take; 
                shotsInMag = 0;
                killsInMag = 0; // –°–±—Ä–æ—Å —Å–µ—Ä–∏–∏ —É–±–∏–π—Å—Ç–≤ –¥–ª—è –∞—á–∏–≤–∫–∏ "–ü–æ–∑–∑–∏ –ü—Ä–∞–π–º"
            }
            updateUI();
        }

        function updateUI() {
            let m = Math.floor(timeLeft/60), s = Math.floor(timeLeft%60);
            document.getElementById('timer-display').innerText = `TIME: ${m}:${s.toString().padStart(2,'0')}`;
            document.getElementById('ammo-display').innerText = `AMMO: ${ammo}/${reserveAmmo} | KILLS: ${enemiesKilled}/${killsToWin}`;
            document.getElementById('health-fill').style.width = player.health + "%";
            
            if(enemiesKilled >= killsToWin && gameRunning) { 
                gameRunning = false; 
                achievements.win1.current++; unlockAch('win1');
                achievements.win5.current++; unlockAch('win5');
                if(currentWepIdx === 0) { achievements.pistol_fan.current = 1; unlockAch('pistol_fan'); }
                showScreen('victory-screen'); 
            }
            if(player.health <= 0 && gameRunning) { gameRunning = false; showScreen('game-over'); }
        }

        function setupMobileControls() {
            const joy = document.getElementById('joystick-container'), stick = document.getElementById('joystick-stick');
            window.addEventListener('touchstart', e => { for(let t of e.changedTouches) if(t.clientX > window.innerWidth/2) lastTouchX = t.clientX; }, {passive:false});
            window.addEventListener('touchmove', e => {
                e.preventDefault();
                for(let t of e.touches) {
                    if(t.clientX < window.innerWidth/2) {
                        let r = joy.getBoundingClientRect();
                        let dx = t.clientX-(r.left+r.width/2), dy = t.clientY-(r.top+r.height/2);
                        let d = Math.min(60, Math.hypot(dx,dy)), ang = Math.atan2(dy,dx);
                        joyPos = {x:(Math.cos(ang)*d)/60, y:(Math.sin(ang)*d)/60};
                        stick.style.transform = `translate(calc(-50% + ${joyPos.x*60}px), calc(-50% + ${joyPos.y*60}px))`;
                    } else if(lastTouchX !== null) { player.dir += (t.clientX-lastTouchX)*0.007; lastTouchX = t.clientX; }
                }
            }, {passive:false});
            window.addEventListener('touchend', e => { joyPos={x:0,y:0}; stick.style.transform='translate(-50%,-50%)'; lastTouchX=null; });
            document.getElementById('shoot-btn').onclick = shoot;
            document.getElementById('reload-btn').onclick = reload;
        }

        window.addEventListener('keydown', e => { keys[e.code] = true; if(e.code==='KeyR') reload(); });
        window.addEventListener('keyup', e => keys[e.code] = false);
        window.addEventListener('mousemove', e => { if(document.pointerLockElement) player.dir += e.movementX*0.003; });
        window.addEventListener('mousedown', () => { if(gameRunning && !isMobile) shoot(); });

        function loop() { update(); draw(); requestAnimationFrame(loop); }
    </script>
</body>
</html>
