<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>KILL FURRY - MULTIPLAYER</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è P2P —Å–≤—è–∑–∏ -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: white; font-family: 'Courier New', Courier, monospace; touch-action: none; }
        canvas { display: block; image-rendering: pixelated; width: 100vw; height: 100vh; }
        
        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
            text-align: center;
        }

        #menu, #weapon-menu, #controls-pc, #controls-mobile, #achievements-menu, #game-over, #victory-screen, #multiplayer-menu { display: none; }
        #menu { display: flex; }
        
        .btn {
            background: #a00; color: white; border: none; padding: 12px 25px;
            margin: 8px; font-size: 18px; cursor: pointer; font-family: inherit; transition: 0.3s;
        }
        .btn:hover { background: #f00; scale: 1.05; }
        .btn-weapon { background: #444; width: 250px; }
        .selected-wep { border: 2px solid lime; background: #222; }

        input { background: #222; color: #fff; border: 1px solid #a00; padding: 10px; font-family: inherit; margin: 10px; text-align: center; }

        #ui { 
            position: absolute; bottom: 20px; left: 20px; 
            pointer-events: none; text-shadow: 2px 2px 2px black; z-index: 10;
        }
        #health-bar { width: 200px; height: 20px; background: #300; border: 2px solid white; margin-bottom: 5px; }
        #health-fill { width: 100%; height: 100%; background: #f00; transition: width 0.3s; }
        
        #joystick-container {
            position: absolute; bottom: 40px; left: 40px;
            width: 120px; height: 120px; background: rgba(255,255,255,0.1);
            border-radius: 50%; display: none; touch-action: none; border: 2px solid rgba(255,255,255,0.3);
        }
        #joystick-stick {
            position: absolute; top: 50%; left: 50%;
            width: 50px; height: 50px; background: rgba(255,255,255,0.4);
            border-radius: 50%; transform: translate(-50%, -50%);
        }

        #shoot-btn, #reload-btn {
            position: absolute; border-radius: 50%; 
            background: rgba(255,0,0,0.5); border: 4px solid white;
            display: none; align-items: center; justify-content: center;
            user-select: none; z-index: 20; touch-action: none;
        }
        #shoot-btn { bottom: 40px; right: 40px; width: 100px; height: 100px; font-size: 40px; }
        #reload-btn { bottom: 150px; right: 55px; width: 70px; height: 70px; font-size: 25px; background: rgba(0,100,255,0.5); }

        #crosshair { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            color: lime; font-size: 24px; font-weight: bold; pointer-events: none;
        }
        #blood-overlay {
            position: absolute; inset: 0; background: radial-gradient(circle, transparent 30%, rgba(150,0,0,0.6) 100%);
            pointer-events: none; opacity: 0; transition: opacity 0.1s; z-index: 5;
        }

        #ach-notification {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9); color: #0f0; padding: 15px 30px;
            border-radius: 5px; font-weight: bold; display: none; z-index: 200;
            border: 2px solid #0f0; box-shadow: 0 0 15px rgba(0,255,0,0.5);
            pointer-events: none; animation: slideDown 0.5s ease;
        }
        @keyframes slideDown { from { top: -100px; } to { top: 20px; } }
    </style>
</head>
<body>

    <div id="blood-overlay"></div>
    <div id="ach-notification"></div>

    <div id="menu" class="overlay">
        <h1>>–£–ë–ï–ô –§–£–†–†–ò<</h1>
        <p>by Karton820: TT</p>
        <button class="btn" onclick="showScreen('weapon-menu')">–ò–ì–†–ê–¢–¨</button>
        <button class="btn" style="background:#555" onclick="showScreen('multiplayer-menu'); initMultiplayer();">–ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†</button>
        <button class="btn" style="background:#555" onclick="toggleAchievements(true)">–î–û–°–¢–ò–ñ–ï–ù–ò–Ø</button>
        <button class="btn" style="background:#007bff" onclick="window.open('https://www.donationalerts.com/r/karton820', '_blank')">–ü–û–î–î–ï–†–ñ–ê–¢–¨</button>
    </div>

    <!-- –ù–æ–≤–æ–µ –º–µ–Ω—é –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–∞ -->
    <div id="multiplayer-menu" class="overlay">
        <h2>–ë–ï–¢–ê-(–ù–ï –†–ê–ë–û–¢–ê–ï–¢)</h2>
        <div id="peer-status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        <div id="my-id-container" style="margin: 10px; color: #0f0;"></div>
        <input type="text" id="remote-id" placeholder="ID –¥—Ä—É–≥–∞">
        <button class="btn" onclick="connectToFriend()">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø –ö –î–†–£–ì–£</button>
        <button class="btn" style="background:#333" onclick="showScreen('menu')">–ù–ê–ó–ê–î</button>
        <p style="font-size: 12px; color: #888;">–î–ª—è –∏–≥—Ä—ã –≤–º–µ—Å—Ç–µ –æ–±–∞ –∏–≥—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç.<br>–û–¥–∏–Ω –¥–∞–µ—Ç —Å–≤–æ–π ID, –≤—Ç–æ—Ä–æ–π –≤–≤–æ–¥–∏—Ç –µ–≥–æ.</p>
    </div>

    <div id="weapon-menu" class="overlay">
        <h2>–í–´–ë–ï–†–ò–¢–ï –û–†–£–ñ–ò–ï</h2>
        <button id="wep0" class="btn btn-weapon selected-wep" onclick="selectWeapon(0)">–ü–ò–°–¢–û–õ–ï–¢</button>
        <button id="wep1" class="btn btn-weapon" onclick="selectWeapon(1)">–î–†–û–ë–û–í–ò–ö</button>
        <button id="wep2" class="btn btn-weapon" onclick="selectWeapon(2)">–ê–í–¢–û–ú–ê–¢</button>
        <button class="btn" onclick="showScreen('controls-pc')">–ü–ö</button>
        <button class="btn" onclick="showScreen('controls-mobile')">–¢–ï–õ–ï–§–û–ù</button>
    </div>

    <div id="controls-pc" class="overlay">
        <h2>–£–ü–†–ê–í–õ–ï–ù–ò–ï (–ü–ö)</h2>
        <p>WASD - –ë–µ–≥, –ú—ã—à—å - –û–≥–æ–Ω—å, R - –ó–∞—Ä—è–¥–∫–∞</p>
        <button class="btn" onclick="startGame('pc')">–í –ë–û–ô!</button>
    </div>

    <div id="controls-mobile" class="overlay">
        <h2>–£–ü–†–ê–í–õ–ï–ù–ò–ï (MOBILE)</h2>
        <p>–õ–µ–≤—ã–π —Å—Ç–∏–∫ - –•–æ–¥—å–±–∞, –ü—Ä–∞–≤—ã–π —ç–∫—Ä–∞–Ω - –û–±–∑–æ—Ä</p>
        <button class="btn" onclick="startGame('mobile')">–í –ë–û–ô!</button>
    </div>

    <div id="achievements-menu" class="overlay">
        <h2>–î–û–°–¢–ò–ñ–ï–ù–ò–Ø</h2>
        <div id="ach-container" style="text-align: left; width: 90%; max-width: 500px; margin-bottom: 20px; overflow-y: auto; max-height: 65vh; background: #111; padding: 10px; border: 1px solid #444;"></div>
        <button class="btn" onclick="showScreen('menu')">–í –ú–ï–ù–Æ</button>
    </div>

    <div id="game-over" class="overlay" style="background: rgba(50, 0, 0, 0.9);">
        <h1 style="color:red; font-size:60px;">–¢–´ –ü–û–ì–ò–ë</h1>
        <button class="btn" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
    </div>

    <div id="victory-screen" class="overlay" style="background: rgba(0, 50, 0, 0.9);">
        <h1 style="color:lime;">–ó–ê–ß–ò–°–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!</h1>
        <button class="btn" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
    </div>

    <div id="joystick-container"><div id="joystick-stick"></div></div>
    <div id="shoot-btn">üî•</div>
    <div id="reload-btn">üîÑ</div>

    <canvas id="screen"></canvas>
    <div id="crosshair">+</div>
    <div id="ui">
        <div id="timer-display">TIME: 03:00</div>
        <div id="health-bar"><div id="health-fill"></div></div>
        <div id="ammo-display">AMMO: 10/30 | KILLS: 0/15</div>
    </div>

    <script>
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const screenWidth = 320, screenHeight = 200;
        canvas.width = screenWidth; canvas.height = screenHeight;

        // –ö–æ–¥ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–∞
        let peer, conn;
        let otherPlayer = { x: 0, y: 0, active: false };

        function initMultiplayer() {
            if (peer) return;
            peer = new Peer();
            peer.on('open', (id) => {
                document.getElementById('my-id-container').innerText = "–¢–≤–æ–π ID: " + id;
                document.getElementById('peer-status').innerText = "–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é";
            });
            peer.on('connection', (c) => {
                conn = c;
                setupConn();
                showScreen('weapon-menu');
            });
        }

        function connectToFriend() {
            const remoteId = document.getElementById('remote-id').value;
            if (remoteId) {
                conn = peer.connect(remoteId);
                setupConn();
                showScreen('weapon-menu');
            }
        }

        function setupConn() {
            conn.on('data', (data) => {
                if (data.type === 'pos') {
                    otherPlayer.x = data.x;
                    otherPlayer.y = data.y;
                    otherPlayer.active = true;
                }
            });
        }

        const enemySprite = new Image(); enemySprite.src = 'furry.png';
        const itemSprite = new Image(); itemSprite.src = 'item.jpg';

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playShootSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        const map = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,2,0,0,1,0,2,0,2,0,1,1,0,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1],
            [1,0,1,1,1,1,0,1,0,1,1,0,1,1,1,1,0,1,0,1],
            [1,0,2,0,0,0,0,1,0,0,0,0,0,0,2,0,0,0,0,1],
            [1,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,1,1,0,1],
            [1,0,1,0,1,0,0,0,0,0,0,1,0,1,1,0,1,0,0,1],
            [1,0,0,0,1,0,2,0,2,0,0,1,0,0,0,0,1,0,2,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];
        const mapW = map[0].length, mapH = map.length;

        const weaponTypes = [
            { name: "–ü–∏—Å—Ç–æ–ª–µ—Ç", clip: 10, reserve: 60, range: 10, spread: 0.1, pack: 10 },
            { name: "–î—Ä–æ–±–æ–≤–∏–∫", clip: 4, reserve: 24, range: 4, spread: 0.4, pack: 4 },
            { name: "–ê–≤—Ç–æ–º–∞—Ç", clip: 30, reserve: 90, range: 8, spread: 0.2, pack: 30 }
        ];
        
        let currentWepIdx = 0, ammo = 10, reserveAmmo = 60, shotsInMag = 0;
        let player = { x: 2, y: 2, dir: 0, speed: 0.15, health: 100 };
        let gameRunning = false, isMobile = false, enemiesKilled = 0, timeLeft = 180;
        const killsToWin = 15;
        
        let enemies = [], items = [], deadBodies = [], particles = [], flash = 0, itemsCollectedCount = 0;
        let zBuffer = new Array(screenWidth), keys = {}, lastTouchX = null, joyPos = { x: 0, y: 0 };
        
        let killsWithoutDamage = 0, killsInMag = 0, pacifistTimer = 0, medkitStreak = 0, gamesPlayed = 0;

        let achievements = {
            k1: { name: "–ü–µ—Ä–≤—ã–π —Ñ—É—Ä—Ä–∏", desc: "–£–±–∏—Ç—å 1 —Ñ—É—Ä—Ä–∏", icon: "üíÄ", goal: 1, current: 0, unlocked: false },
            k10: { name: "–û—Ö–æ—Ç–Ω–∏–∫", desc: "–£–±–∏—Ç—å 10 —Ñ—É—Ä—Ä–∏", icon: "üèπ", goal: 10, current: 0, unlocked: false },
            k25: { name: "–ò—Å—Ç—Ä–µ–±–∏—Ç–µ–ª—å", desc: "–£–±–∏—Ç—å 25 —Ñ—É—Ä—Ä–∏", icon: "‚öîÔ∏è", goal: 25, current: 0, unlocked: false },
            k50: { name: "–ú—è—Å–Ω–∏–∫", desc: "–£–±–∏—Ç—å 50 —Ñ—É—Ä—Ä–∏", icon: "ü©∏", goal: 50, current: 0, unlocked: false },
            k75: { name: "–ü–∞–ª–∞—á", desc: "–£–±–∏—Ç—å 75 —Ñ—É—Ä—Ä–∏", icon: "üëø", goal: 75, current: 0, unlocked: false },
            k100: { name: "–ú–∞—Å—Ç–µ—Ä —Å–º–µ—Ä—Ç–∏", desc: "–£–±–∏—Ç—å 100 —Ñ—É—Ä—Ä–∏", icon: "üî•", goal: 100, current: 0, unlocked: false },
            k250: { name: "–õ–µ–≥–µ–Ω–¥–∞ –ø—É—Å—Ç–æ—à–µ–π", desc: "–£–±–∏—Ç—å 250 —Ñ—É—Ä—Ä–∏", icon: "üëë", goal: 250, current: 0, unlocked: false },
            k500: { name: "–ì–µ–Ω–æ—Ü–∏–¥", desc: "–£–±–∏—Ç—å 500 —Ñ—É—Ä—Ä–∏", icon: "‚ò¢Ô∏è", goal: 500, current: 0, unlocked: false },
            k1000: { name: "–ë–æ–≥ –í–æ–π–Ω—ã", desc: "–£–±–∏—Ç—å 1000 —Ñ—É—Ä—Ä–∏", icon: "‚òÑÔ∏è", goal: 1000, current: 0, unlocked: false },
            win1: { name: "–í—ã–∂–∏–≤—à–∏–π", desc: "–ü—Ä–æ–π—Ç–∏ –∏–≥—Ä—É 1 —Ä–∞–∑", icon: "üèÜ", goal: 1, current: 0, unlocked: false },
            win5: { name: "–í–µ—Ç–µ—Ä–∞–Ω", desc: "–ü—Ä–æ–π—Ç–∏ –∏–≥—Ä—É 5 —Ä–∞–∑", icon: "ü•á", goal: 5, current: 0, unlocked: false },
            win10: { name: "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª", desc: "–ü—Ä–æ–π—Ç–∏ –∏–≥—Ä—É 10 —Ä–∞–∑", icon: "üéñÔ∏è", goal: 10, current: 0, unlocked: false },
            win25: { name: "–ù–µ—É–¥–µ—Ä–∂–∏–º—ã–π", desc: "–ü—Ä–æ–π—Ç–∏ –∏–≥—Ä—É 25 —Ä–∞–∑", icon: "üíé", goal: 25, current: 0, unlocked: false },
            win50: { name: "–ì—Ä–æ—Å—Å–º–µ–π—Å—Ç–µ—Ä", desc: "–ü—Ä–æ–π—Ç–∏ –∏–≥—Ä—É 50 —Ä–∞–∑", icon: "üåå", goal: 50, current: 0, unlocked: false },
            fast: { name: "–°–ø–∏–¥—Ä–∞–Ω–Ω–µ—Ä", desc: "–£–±–∏—Ç—å —Ñ—É—Ä—Ä–∏ –≤ –ø–µ—Ä–≤—ã–µ 5 —Å–µ–∫—É–Ω–¥", icon: "‚ö°", goal: 1, current: 0, unlocked: false },
            fast_3s: { name: "–†–µ–∞–∫—Ü–∏—è –º–∞–Ω–≥—É—Å—Ç–∞", desc: "–£–±–∏—Ç—å —Ñ—É—Ä—Ä–∏ –≤ –ø–µ—Ä–≤—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã", icon: "üå©Ô∏è", goal: 1, current: 0, unlocked: false },
            fast_win: { name: "–ú–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω—ã–π", desc: "–ü–æ–±–µ–¥–∏—Ç—å –º–µ–Ω–µ–µ —á–µ–º –∑–∞ 60 —Å–µ–∫—É–Ω–¥", icon: "‚è±Ô∏è", goal: 1, current: 0, unlocked: false },
            no_dmg: { name: "–ù–µ–ø—Ä–∏–∫–∞—Å–∞–µ–º—ã–π", desc: "–£–±–∏—Ç—å 5 —Ñ—É—Ä—Ä–∏ –ø–æ–¥—Ä—è–¥ –±–µ–∑ —É—Ä–æ–Ω–∞", icon: "üõ°Ô∏è", goal: 5, current: 0, unlocked: false },
            no_dmg_10: { name: "–ü—Ä–∏–∑—Ä–∞–∫", desc: "–£–±–∏—Ç—å 10 —Ñ—É—Ä—Ä–∏ –ø–æ–¥—Ä—è–¥ –±–µ–∑ —É—Ä–æ–Ω–∞", icon: "üëª", goal: 10, current: 0, unlocked: false },
            no_dmg_15: { name: "–¢–µ–Ω—å", desc: "–£–±–∏—Ç—å 15 —Ñ—É—Ä—Ä–∏ –ø–æ–¥—Ä—è–¥ –±–µ–∑ —É—Ä–æ–Ω–∞", icon: "üï∂Ô∏è", goal: 15, current: 0, unlocked: false },
            low_hp: { name: "–ù–∞ –≤–æ–ª–æ—Å–∫–µ", desc: "–£–±–∏—Ç—å –≤—Ä–∞–≥–∞, –∏–º–µ—è –º–µ–Ω—å—à–µ 10% –∑–¥–æ—Ä–æ–≤—å—è", icon: "ü©π", goal: 1, current: 0, unlocked: false },
            low_hp_5: { name: "–£ –∫—Ä–∞—è –±–µ–∑–¥–Ω—ã", desc: "–£–±–∏—Ç—å –≤—Ä–∞–≥–∞, –∏–º–µ—è –º–µ–Ω—å—à–µ 5% –∑–¥–æ—Ä–æ–≤—å—è", icon: "üíÄ", goal: 1, current: 0, unlocked: false },
            empty: { name: "–î–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ", desc: "–í—ã—Å—Ç—Ä–µ–ª–∏—Ç—å –≤—Å—é –æ–±–æ–π–º—É", icon: "üî´", goal: 1, current: 0, unlocked: false },
            trigger_happy: { name: "–ì–∞—Ç–ª–∏–Ω–≥", desc: "–û–ø—É—Å—Ç–æ—à–∏—Ç—å 10 –º–∞–≥–∞–∑–∏–Ω–æ–≤", icon: "üí•", goal: 10, current: 0, unlocked: false },
            pistol_fan: { name: "–ö–ª–∞—Å—Å–∏–∫–∞", desc: "–ü–æ–±–µ–¥–∏—Ç—å —Å –ø–∏—Å—Ç–æ–ª–µ—Ç–æ–º", icon: "üéØ", goal: 1, current: 0, unlocked: false },
            shotgun_fan: { name: "–î—Ä–æ–±–æ–≤–∏–∫-—à–æ—É", desc: "–ü–æ–±–µ–¥–∏—Ç—å —Å –¥—Ä–æ–±–æ–≤–∏–∫–æ–º", icon: "üì¢", goal: 1, current: 0, unlocked: false },
            rifle_fan: { name: "–°–≤–∏–Ω—Ü–æ–≤—ã–π –¥–æ–∂–¥—å", desc: "–ü–æ–±–µ–¥–∏—Ç—å —Å –∞–≤—Ç–æ–º–∞—Ç–æ–º", icon: "üåßÔ∏è", goal: 1, current: 0, unlocked: false },
            rich: { name: "–ó–∞–ø–∞—Å–ª–∏–≤—ã–π", desc: "–°–æ–±—Ä–∞—Ç—å 100 –ø–∞—Ç—Ä–æ–Ω–æ–≤", icon: "üì¶", goal: 100, current: 0, unlocked: false },
            rich_500: { name: "–°–Ω–∞–±–∂–µ–Ω–µ—Ü", desc: "–°–æ–±—Ä–∞—Ç—å 500 –ø–∞—Ç—Ä–æ–Ω–æ–≤", icon: "üöö", goal: 500, current: 0, unlocked: false },
            rich_1000: { name: "–ê—Ä—Å–µ–Ω–∞–ª", desc: "–°–æ–±—Ä–∞—Ç—å 1000 –ø–∞—Ç—Ä–æ–Ω–æ–≤", icon: "üè¶", goal: 1000, current: 0, unlocked: false },
            medic_waste: { name: "–ò–ø–æ—Ö–æ–Ω–¥—Ä–∏–∫", desc: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ø—Ç–µ—á–∫—É –ø—Ä–∏ 100 HP", icon: "üíä", goal: 1, current: 0, unlocked: false },
            medic: { name: "–ü–æ–ª–µ–≤–æ–π –≤—Ä–∞—á", desc: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 1 –∞–ø—Ç–µ—á–∫—É", icon: "üè•", goal: 1, current: 0, unlocked: false },
            medic_10: { name: "–•–∏—Ä—É—Ä–≥", desc: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 10 –∞–ø—Ç–µ—á–µ–∫", icon: "üë®‚Äç‚öïÔ∏è", goal: 10, current: 0, unlocked: false },
            medic_50: { name: "–ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π", desc: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 50 –∞–ø—Ç–µ—á–µ–∫", icon: "üßõ", goal: 50, current: 0, unlocked: false },
            explorer: { name: "–¢—É—Ä–∏—Å—Ç", desc: "–ü—Ä–æ–π—Ç–∏ 500 —à–∞–≥–æ–≤", icon: "üë£", goal: 500, current: 0, unlocked: false },
            marathon: { name: "–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü", desc: "–ü—Ä–æ–π—Ç–∏ 5000 —à–∞–≥–æ–≤", icon: "üèÉ", goal: 5000, current: 0, unlocked: false },
            nomad: { name: "–°—Ç—Ä–∞–Ω–Ω–∏–∫", desc: "–ü—Ä–æ–π—Ç–∏ 10000 —à–∞–≥–æ–≤", icon: "üó∫Ô∏è", goal: 10000, current: 0, unlocked: false },
            ninja: { name: "–ù–∏–Ω–¥–∑—è", desc: "–ü–æ–¥–æ–π—Ç–∏ –∫ –≤—Ä–∞–≥—É –≤–ø–ª–æ—Ç–Ω—É—é", icon: "üë§", goal: 1, current: 0, unlocked: false },
            assassin: { name: "–ê—Å—Å–∞—Å–∏–Ω", desc: "–£–±–∏—Ç—å 5 –≤—Ä–∞–≥–æ–≤ –≤–ø–ª–æ—Ç–Ω—É—é", icon: "üó°Ô∏è", goal: 5, current: 0, unlocked: false },
            sniper: { name: "–°–Ω–∞–π–ø–µ—Ä", desc: "–£–±–∏—Ç—å –≤—Ä–∞–≥–∞ –Ω–∞ –º–∞–∫—Å. –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏", icon: "üëÅÔ∏è", goal: 1, current: 0, unlocked: false },
            deadeye: { name: "–ó–æ—Ä–∫–∏–π –≥–ª–∞–∑", desc: "5 —É–±–∏–π—Å—Ç–≤ –Ω–∞ –º–∞–∫—Å. –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏", icon: "üî≠", goal: 5, current: 0, unlocked: false },
            collector: { name: "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä", desc: "–°–æ–±—Ä–∞—Ç—å 10 –ø—Ä–µ–¥–º–µ—Ç–æ–≤", icon: "üíé", goal: 10, current: 0, unlocked: false },
            scavenger: { name: "–ú—É—Å–æ—Ä—â–∏–∫", desc: "–°–æ–±—Ä–∞—Ç—å 50 –ø—Ä–µ–¥–º–µ—Ç–æ–≤", icon: "üßπ", goal: 50, current: 0, unlocked: false },
            artifact: { name: "–ò—Å–∫–∞—Ç–µ–ª—å", desc: "–°–æ–±—Ä–∞—Ç—å 100 –ø—Ä–µ–¥–º–µ—Ç–æ–≤", icon: "üè∫", goal: 100, current: 0, unlocked: false },
            pacifist: { name: "–ü–∞—Ü–∏—Ñ–∏—Å—Ç?", desc: "30 —Å–µ–∫. –±–µ–∑ –≤—ã—Å—Ç—Ä–µ–ª–æ–≤ –≤ –±–æ—é", icon: "üïäÔ∏è", goal: 30, current: 0, unlocked: false },
            true_pacifist: { name: "–ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü", desc: "60 —Å–µ–∫. –±–µ–∑ –≤—ã—Å—Ç—Ä–µ–ª–æ–≤ –≤ –±–æ—é", icon: "ü§ù", goal: 60, current: 0, unlocked: false },
            god: { name: "–ü–û–ó–ó–ò –ü–†–ê–ô–ú", desc: "15 —É–±–∏–π—Å—Ç–≤ –±–µ–∑ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏", icon: "üåü", goal: 15, current: 0, unlocked: false },
            lucky: { name: "–í–µ–∑—É–Ω—á–∏–∫", desc: "–ù–∞–π—Ç–∏ 3 –∞–ø—Ç–µ—á–∫–∏ –ø–æ–¥—Ä—è–¥", icon: "üçÄ", goal: 3, current: 0, unlocked: false },
            reloader: { name: "–ú–∞—Å—Ç–µ—Ä –∑–∞—Ç–≤–æ—Ä–∞", desc: "–ü–µ—Ä–µ–∑–∞—Ä—è–¥–∏—Ç—å—Å—è 100 —Ä–∞–∑", icon: "üîÑ", goal: 100, current: 0, unlocked: false },
            persistence: { name: "–£–ø–æ—Ä—Å—Ç–≤–æ", desc: "–°—ã–≥—Ä–∞—Ç—å 10 –∏–≥—Ä", icon: "üéÆ", goal: 10, current: 0, unlocked: false }
        };

        function saveAch() { localStorage.setItem('kf_ach_v3_50', JSON.stringify(achievements)); }
        function loadAch() {
            let s = localStorage.getItem('kf_ach_v3_50');
            if(s) {
                let p = JSON.parse(s);
                for(let k in p) if(achievements[k]) { 
                    achievements[k].unlocked = p[k].unlocked; 
                    achievements[k].current = p[k].current; 
                }
            }
        }
        loadAch();

        function unlockAch(id) {
            let a = achievements[id];
            if(!a.unlocked && a.current >= a.goal) {
                a.unlocked = true;
                let n = document.getElementById('ach-notification');
                n.innerHTML = `üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–ï:<br>${a.name}`;
                n.style.display = 'block';
                setTimeout(() => n.style.display = 'none', 3000);
            }
            saveAch();
        }

        function startGame(mode) {
            isMobile = mode === 'mobile';
            showScreen('none');
            player = { x: 2, y: 2, dir: 0, speed: 0.15, health: 100 };
            enemies = []; items = []; deadBodies = []; particles = [];
            enemiesKilled = 0; timeLeft = 180; shotsInMag = 0; itemsCollectedCount = 0;
            
            achievements.persistence.current++; unlockAch('persistence');

            if(isMobile) {
                document.getElementById('joystick-container').style.display = 'block';
                document.getElementById('shoot-btn').style.display = 'flex';
                document.getElementById('reload-btn').style.display = 'flex';
                setupMobileControls();
            } else canvas.requestPointerLock();
            gameRunning = true;
            updateUI();
            loop();
        }

        function shoot() {
            if (ammo <= 0 || player.health <= 0 || !gameRunning) return;
            playShootSound();
            ammo--; shotsInMag++;
            pacifistTimer = 0;
            flash = 5;
            
            if(ammo === 0) { 
                achievements.empty.current = 1; unlockAch('empty'); 
                achievements.trigger_happy.current++; unlockAch('trigger_happy');
            }

            let wep = weaponTypes[currentWepIdx];
            enemies.forEach(en => {
                if (!en.alive) return;
                let dx = en.x - player.x, dy = en.y - player.y, dist = Math.sqrt(dx*dx + dy*dy);
                let angle = Math.atan2(dy, dx) - player.dir;
                while (angle < -Math.PI) angle += Math.PI * 2;
                while (angle > Math.PI) angle -= Math.PI * 2;
                
                if (Math.abs(angle) < wep.spread && dist < wep.range) {
                    en.alive = false; enemiesKilled++;
                    killsWithoutDamage++;
                    killsInMag++;

                    if(timeLeft > 175) { achievements.fast.current = 1; unlockAch('fast'); }
                    if(timeLeft > 177) { achievements.fast_3s.current = 1; unlockAch('fast_3s'); }
                    
                    achievements.no_dmg.current = killsWithoutDamage; unlockAch('no_dmg');
                    achievements.no_dmg_10.current = killsWithoutDamage; unlockAch('no_dmg_10');
                    achievements.no_dmg_15.current = killsWithoutDamage; unlockAch('no_dmg_15');
                    achievements.god.current = killsInMag; unlockAch('god');

                    for(let i=0; i<8; i++) {
                        particles.push({
                            x: en.x, y: en.y, 
                            vx: (Math.random()-0.5)*0.1, vy: (Math.random()-0.5)*0.1, 
                            life: 40 + Math.random()*30
                        });
                    }
                    deadBodies.push({x: en.x, y: en.y, opacity: 1});
                    
                    // Kill achievements
                    const k_ids = ['k1','k10','k25','k50','k75','k100','k250','k500','k1000'];
                    k_ids.forEach(id => { achievements[id].current++; unlockAch(id); });

                    if(player.health < 10) { achievements.low_hp.current = 1; unlockAch('low_hp'); }
                    if(player.health < 5) { achievements.low_hp_5.current = 1; unlockAch('low_hp_5'); }
                    
                    if(dist > 7.5) { 
                        achievements.sniper.current = 1; unlockAch('sniper'); 
                        achievements.deadeye.current++; unlockAch('deadeye');
                    }
                    if(dist < 1.2) { achievements.assassin.current++; unlockAch('assassin'); }
                    
                    if (Math.random() > 0.5) {
                        items.push({
                            x: en.x, 
                            y: en.y, 
                            type: Math.random() > 0.5 ? 'ammo' : 'medkit', 
                            collected: false
                        });
                    }
                }
            });
            updateUI();
        }

        function update() {
            if (!gameRunning) return;

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –¥—Ä—É–≥—É –≤ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–µ
            if (conn && conn.open) {
                conn.send({ type: 'pos', x: player.x, y: player.y });
            }

            if (timeLeft > 0) timeLeft -= 1/60;

            pacifistTimer += 1/60;
            achievements.pacifist.current = pacifistTimer; unlockAch('pacifist');
            achievements.true_pacifist.current = pacifistTimer; unlockAch('true_pacifist');

            let mx = 0, my = 0;
            if (isMobile) {
                mx = (-joyPos.y * Math.cos(player.dir) + joyPos.x * Math.cos(player.dir + Math.PI/2)) * player.speed;
                my = (-joyPos.y * Math.sin(player.dir) + joyPos.x * Math.sin(player.dir + Math.PI/2)) * player.speed;
            } else {
                if (keys['KeyW']) { mx += Math.cos(player.dir); my += Math.sin(player.dir); }
                if (keys['KeyS']) { mx -= Math.cos(player.dir); my -= Math.sin(player.dir); }
                if (keys['KeyA']) { mx += Math.cos(player.dir - Math.PI/2); my += Math.sin(player.dir - Math.PI/2); }
                if (keys['KeyD']) { mx += Math.cos(player.dir + Math.PI/2); my += Math.sin(player.dir + Math.PI/2); }
                let mag = Math.sqrt(mx*mx+my*my); if(mag>0) { mx=(mx/mag)*player.speed; my=(my/mag)*player.speed; }
            }
            
            if (map[Math.floor(player.y)][Math.floor(player.x + mx*2)] === 0) player.x += mx;
            if (map[Math.floor(player.y + my*2)][Math.floor(player.x)] === 0) player.y += my;
            
            if(mx !== 0 || my !== 0) { 
                achievements.explorer.current += 0.5; unlockAch('explorer'); 
                achievements.marathon.current += 0.5; unlockAch('marathon'); 
                achievements.nomad.current += 0.5; unlockAch('nomad'); 
            }

            items.forEach(it => {
                if(!it.collected) {
                    let d = Math.hypot(it.x - player.x, it.y - player.y);
                    if(d < 0.5) {
                        it.collected = true;
                        itemsCollectedCount++;
                        achievements.collector.current++; unlockAch('collector');
                        achievements.scavenger.current++; unlockAch('scavenger');
                        achievements.artifact.current++; unlockAch('artifact');
                        
                        if(it.type === 'medkit') {
                            medkitStreak++;
                            achievements.lucky.current = medkitStreak; unlockAch('lucky');
                            if(player.health >= 100) { achievements.medic_waste.current = 1; unlockAch('medic_waste'); }
                            player.health = Math.min(100, player.health + 30);
                            achievements.medic.current++; unlockAch('medic');
                            achievements.medic_10.current++; unlockAch('medic_10');
                            achievements.medic_50.current++; unlockAch('medic_50');
                        } else {
                            medkitStreak = 0; 
                            let add = weaponTypes[currentWepIdx].pack;
                            reserveAmmo += add;
                            achievements.rich.current += add; unlockAch('rich');
                            achievements.rich_500.current += add; unlockAch('rich_500');
                            achievements.rich_1000.current += add; unlockAch('rich_1000');
                        }
                    }
                }
            });

            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life--;
                if(p.life <= 0) particles.splice(i, 1);
            });
            deadBodies.forEach(b => { if(b.opacity > 0) b.opacity -= 0.001; });

            enemies.forEach(en => {
                if (!en.alive) return;
                let dx = player.x - en.x, dy = player.y - en.y, d = Math.sqrt(dx*dx + dy*dy);
                if (d < 0.6) { 
                    player.health -= 0.5; 
                    killsWithoutDamage = 0; 
                }
                else if (d < 8) {
                    let vx = (dx/d)*0.02, vy = (dy/d)*0.02;
                    if(map[Math.floor(en.y)][Math.floor(en.x + vx*3)] === 0) en.x += vx;
                    if(map[Math.floor(en.y + vy*3)][Math.floor(en.x)] === 0) en.y += vy;
                    if(d < 0.8) { achievements.ninja.current = 1; unlockAch('ninja'); }
                }
            });

            if (Math.random() < 0.02 && enemies.filter(e=>e.alive).length < 6) {
                let rx = Math.random()*(mapW-2)+1, ry = Math.random()*(mapH-2)+1;
                if(map[Math.floor(ry)][Math.floor(rx)] === 0) enemies.push({x:rx, y:ry, alive:true});
            }
            
            if(flash > 0) flash--;
            updateUI();
        }

        function draw() {
            ctx.fillStyle = "#101"; ctx.fillRect(0,0,screenWidth,screenHeight/2);
            ctx.fillStyle = "#111"; ctx.fillRect(0,screenHeight/2,screenWidth,screenHeight/2);
            
            for (let i = 0; i < screenWidth; i++) {
                let angle = (player.dir - 0.5) + (i / screenWidth), d = 0, hit = 0;
                while (hit === 0 && d < 15) {
                    d += 0.05;
                    let tx = Math.floor(player.x + Math.cos(angle)*d), ty = Math.floor(player.y + Math.sin(angle)*d);
                    if (tx < 0 || tx >= mapW || ty < 0 || ty >= mapH) { hit = 1; d = 15; } else hit = map[ty][tx];
                }
                zBuffer[i] = d * Math.cos(angle - player.dir);
                let h = screenHeight / zBuffer[i], c = 160 / (1 + d * 0.25);
                ctx.fillStyle = hit === 1 ? `rgb(${c},0,0)` : `rgb(40,40,${c})`;
                ctx.fillRect(i, screenHeight/2 - h/2, 1, h);
            }
            
            let sprites = [];
            deadBodies.forEach(b => { if(b.opacity > 0.1) sprites.push({x:b.x, y:b.y, type:'blood', op:b.opacity})});
            particles.forEach(p => sprites.push({x:p.x, y:p.y, type:'gore'}));
            enemies.forEach(e => { if(e.alive) sprites.push({...e, type:'enemy'})});
            items.forEach(it => { if(!it.collected) sprites.push({...it, type:it.type})});
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            if (otherPlayer.active) {
                sprites.push({x: otherPlayer.x, y: otherPlayer.y, type: 'player2'});
            }
            
            sprites.sort((a,b) => Math.hypot(b.x-player.x, b.y-player.y) - Math.hypot(a.x-player.x, a.y-player.y));
            
            sprites.forEach(s => {
                let dx = s.x - player.x, dy = s.y - player.y, dist = Math.sqrt(dx*dx+dy*dy);
                let ang = Math.atan2(dy, dx) - player.dir;
                while (ang < -Math.PI) ang += Math.PI*2; 
                while (ang > Math.PI) ang -= Math.PI*2;
                
                if (Math.abs(ang) < 0.8 && dist > 0.1 && dist < 15) {
                    let sx = (ang / 1 + 0.5) * screenWidth;
                    if (zBuffer[Math.floor(sx)] > dist) {
                        let h = screenHeight / dist, w = h * 0.5;
                        if(s.type === 'blood') {
                            ctx.fillStyle = `rgba(100,0,0,${s.op})`;
                            ctx.fillRect(sx-w, screenHeight/2+h/4, w*2, h/10);
                        } else if(s.type === 'gore') {
                            ctx.fillStyle = "#f00"; ctx.fillRect(sx, screenHeight/2+Math.random()*20, 2, 2);
                        } else if(s.type === 'enemy') {
                            try { ctx.drawImage(enemySprite, sx-w/2, screenHeight/2-h/2, w, h); }
                            catch(e) { ctx.fillStyle = 'red'; ctx.fillRect(sx-w/2, screenHeight/2-h/2, w, h); }
                        } else if(s.type === 'player2') {
                            ctx.fillStyle = '#00f'; // –í—Ç–æ—Ä–æ–π –∏–≥—Ä–æ–∫ —Å–∏–Ω–∏–π
                            ctx.fillRect(sx-w/4, screenHeight/2-h/2, w/2, h);
                        } else {
                            ctx.fillStyle = s.type === 'medkit' ? '#fff' : '#ff0';
                            ctx.fillRect(sx-w/4, screenHeight/2, w/2, h/2);
                            ctx.fillStyle = s.type === 'medkit' ? '#f00' : '#000';
                            ctx.fillRect(sx-2, screenHeight/2 + h/4 - 2, 4, 4);
                        }
                    }
                }
            });
            if (flash > 0) { ctx.fillStyle = `rgba(255,255,255,${flash*0.15})`; ctx.fillRect(0,0,screenWidth,screenHeight); }
        }

        function showScreen(id) {
            document.querySelectorAll('.overlay').forEach(s => s.style.display = 'none');
            if(id !== 'none') document.getElementById(id).style.display = 'flex';
        }

        function toggleAchievements(show) {
            if(show) {
                showScreen('achievements-menu');
                let cont = document.getElementById('ach-container');
                cont.innerHTML = '';
                for(let id in achievements) {
                    let a = achievements[id];
                    cont.innerHTML += `<div style="padding:8px; border-bottom:1px solid #222; color:${a.unlocked?'#0f0':'#555'}; background:${a.unlocked?'#020':'transparent'}">
                        ${a.icon} <b>${a.name}</b> [${Math.floor(a.current)}/${a.goal}]<br>
                        <small style="color:${a.unlocked?'#0a0':'#444'}">${a.desc}</small>
                    </div>`;
                }
            } else showScreen('menu');
        }

        function selectWeapon(idx) {
            currentWepIdx = idx;
            document.querySelectorAll('.btn-weapon').forEach((b, i) => b.classList.toggle('selected-wep', i === idx));
            ammo = weaponTypes[idx].clip; reserveAmmo = weaponTypes[idx].reserve;
            shotsInMag = 0; killsInMag = 0;
        }

        function reload() {
            let m = weaponTypes[currentWepIdx].clip;
            if(ammo < m && reserveAmmo > 0) {
                let take = Math.min(m - ammo, reserveAmmo);
                ammo += take; reserveAmmo -= take; 
                shotsInMag = 0;
                killsInMag = 0;
                achievements.reloader.current++; unlockAch('reloader');
            }
            updateUI();
        }

        function updateUI() {
            if (timeLeft < 0) timeLeft = 0;
            let m = Math.floor(timeLeft/60), s = Math.floor(timeLeft%60);
            document.getElementById('timer-display').innerText = `TIME: ${m}:${s.toString().padStart(2,'0')}`;
            
            document.getElementById('ammo-display').innerText = `AMMO: ${ammo}/${reserveAmmo} | KILLS: ${enemiesKilled}/${killsToWin}`;
            document.getElementById('health-fill').style.width = player.health + "%";
            
            if(enemiesKilled >= killsToWin && gameRunning) { 
                gameRunning = false; 
                const win_ids = ['win1','win5','win10','win25','win50'];
                win_ids.forEach(id => { achievements[id].current++; unlockAch(id); });
                
                if(currentWepIdx === 0) { achievements.pistol_fan.current = 1; unlockAch('pistol_fan'); }
                if(currentWepIdx === 1) { achievements.shotgun_fan.current = 1; unlockAch('shotgun_fan'); }
                if(currentWepIdx === 2) { achievements.rifle_fan.current = 1; unlockAch('rifle_fan'); }
                if(timeLeft > 120) { achievements.fast_win.current = 1; unlockAch('fast_win'); }
                
                showScreen('victory-screen'); 
            }
            if(player.health <= 0 && gameRunning) { 
                gameRunning = false; 
                showScreen('game-over'); 
            }
            if(timeLeft <= 0 && gameRunning) {
                gameRunning = false;
                showScreen('game-over');
            }
        }

        function setupMobileControls() {
            const joy = document.getElementById('joystick-container'), stick = document.getElementById('joystick-stick');
            window.addEventListener('touchstart', e => { for(let t of e.changedTouches) if(t.clientX > window.innerWidth/2) lastTouchX = t.clientX; }, {passive:false});
            window.addEventListener('touchmove', e => {
                e.preventDefault();
                for(let t of e.touches) {
                    if(t.clientX < window.innerWidth/2) {
                        let r = joy.getBoundingClientRect();
                        let dx = t.clientX-(r.left+r.width/2), dy = t.clientY-(r.top+r.height/2);
                        let d = Math.min(60, Math.hypot(dx,dy)), ang = Math.atan2(dy,dx);
                        joyPos = {x:(Math.cos(ang)*d)/60, y:(Math.sin(ang)*d)/60};
                        stick.style.transform = `translate(calc(-50% + ${joyPos.x*60}px), calc(-50% + ${joyPos.y*60}px))`;
                    } else if(lastTouchX !== null) { player.dir += (t.clientX-lastTouchX)*0.007; lastTouchX = t.clientX; }
                }
            }, {passive:false});
            window.addEventListener('touchend', e => { joyPos={x:0,y:0}; stick.style.transform='translate(-50%,-50%)'; lastTouchX=null; });
            document.getElementById('shoot-btn').onclick = shoot;
            document.getElementById('reload-btn').onclick = reload;
        }

        window.addEventListener('keydown', e => { keys[e.code] = true; if(e.code==='KeyR') reload(); });
        window.addEventListener('keyup', e => keys[e.code] = false);
        window.addEventListener('mousemove', e => { if(document.pointerLockElement) player.dir += e.movementX*0.003; });
        window.addEventListener('mousedown', () => { if(gameRunning && !isMobile) shoot(); });

        function loop() { update(); draw(); requestAnimationFrame(loop); }
    </script>
</body>
</html>
