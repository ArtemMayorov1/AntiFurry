<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>KILL FURRY</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: white; font-family: 'Courier New', Courier, monospace; touch-action: none; }
        canvas { display: block; image-rendering: pixelated; width: 100vw; height: 100vh; }
        
        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
            text-align: center;
        }

        #menu, #weapon-menu, #controls-pc, #controls-mobile, #achievements-menu, #game-over, #victory-screen, #multiplayer-menu, #settings-menu { display: none; }
        #menu { display: flex; }
        
        .btn {
            background: #a00; color: white; border: none; padding: 12px 25px;
            margin: 8px; font-size: 18px; cursor: pointer; font-family: inherit; transition: 0.3s;
        }
        .btn:hover { background: #f00; scale: 1.05; }
        .btn-weapon { background: #444; width: 250px; }
        .selected-wep { border: 2px solid lime; background: #222; }

        input { background: #222; color: #fff; border: 1px solid #a00; padding: 10px; font-family: inherit; margin: 10px; text-align: center; }

        .setting-row { margin: 15px; width: 300px; display: flex; justify-content: space-between; align-items: center; }
        input[type=range] { width: 150px; cursor: pointer; }

        #ui { 
            position: absolute; bottom: 20px; left: 20px; 
            pointer-events: none; text-shadow: 2px 2px 2px black; z-index: 10;
        }
        #health-bar { width: 200px; height: 20px; background: #300; border: 2px solid white; margin-bottom: 5px; }
        #health-fill { width: 100%; height: 100%; background: #f00; transition: width 0.3s; }
        
        #joystick-container {
            position: absolute; bottom: 40px; left: 40px;
            width: 120px; height: 120px; background: rgba(255,255,255,0.1);
            border-radius: 50%; display: none; touch-action: none; border: 2px solid rgba(255,255,255,0.3);
        }
        #joystick-stick {
            position: absolute; top: 50%; left: 50%;
            width: 50px; height: 50px; background: rgba(255,255,255,0.4);
            border-radius: 50%; transform: translate(-50%, -50%);
        }

        #shoot-btn, #reload-btn, #mobile-menu-btn {
            position: absolute; border-radius: 50%; 
            background: rgba(255,0,0,0.5); border: 4px solid white;
            display: none; align-items: center; justify-content: center;
            user-select: none; z-index: 20; touch-action: none;
        }
        #shoot-btn { bottom: 40px; right: 40px; width: 100px; height: 100px; font-size: 40px; }
        #reload-btn { bottom: 150px; right: 55px; width: 70px; height: 70px; font-size: 25px; background: rgba(0,100,255,0.5); }
        #mobile-menu-btn { top: 20px; right: 20px; width: 60px; height: 60px; font-size: 20px; border-radius: 10px; background: rgba(50,50,50,0.7); }

        #crosshair { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            color: lime; font-size: 24px; font-weight: bold; pointer-events: none;
        }
        #blood-overlay {
            position: absolute; inset: 0; background: radial-gradient(circle, transparent 30%, rgba(150,0,0,0.6) 100%);
            pointer-events: none; opacity: 0; transition: opacity 0.1s; z-index: 5;
        }

        #ach-notification {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9); color: #0f0; padding: 15px 30px;
            border-radius: 5px; font-weight: bold; display: none; z-index: 200;
            border: 2px solid #0f0; box-shadow: 0 0 15px rgba(0,255,0,0.5);
            pointer-events: none; animation: slideDown 0.5s ease;
        }
        @keyframes slideDown { from { top: -100px; } to { top: 20px; } }
    </style>
</head>
<body>

    <div id="blood-overlay"></div>
    <div id="ach-notification"></div>

    <div id="menu" class="overlay">
        <h1>>–£–ë–ï–ô –§–£–†–†–ò<</h1>
        <button id="resume-btn" class="btn" style="display:none; background: #0a0;" onclick="resumeGame()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
        <button class="btn" onclick="showScreen('weapon-menu')">–ù–û–í–ê–Ø –ò–ì–†–ê</button>
        <button class="btn" style="background:#444" onclick="showScreen('settings-menu')">–ù–ê–°–¢–†–û–ô–ö–ò</button>
        <button class="btn" style="background:#555" onclick="showScreen('multiplayer-menu'); initMultiplayer();">–ú–£–õ–¨–¢–ò–ü–õ–ï–ï–† (BETA)</button>
        <button class="btn" style="background:#555" onclick="toggleAchievements(true)">–î–û–°–¢–ò–ñ–ï–ù–ò–Ø</button>
        <button class="btn" style="background:#d4af37; color: black; font-weight: bold;" onclick="window.open('https://www.donationalerts.com/r/karton820', '_blank')">–ü–û–î–î–ï–†–ñ–ê–¢–¨</button>
    </div>

    <div id="settings-menu" class="overlay">
        <h2>–ù–ê–°–¢–†–û–ô–ö–ò</h2>
        <div class="setting-row"><span>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span><input type="range" id="sens-slider" min="0.1" max="3" step="0.1" value="1"></div>
        <div class="setting-row"><span>–ì—Ä–æ–º–∫–æ—Å—Ç—å</span><input type="range" id="vol-slider" min="0" max="1" step="0.05" value="0.5"></div>
        <button class="btn" onclick="showScreen('menu')">–ù–ê–ó–ê–î</button>
    </div>

    <div id="multiplayer-menu" class="overlay">
        <h2>–ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†</h2>
        <div id="peer-status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
        <div id="my-id-container" style="margin: 10px; color: #0f0;"></div>
        <input type="text" id="remote-id" placeholder="ID –¥—Ä—É–≥–∞">
        <button class="btn" onclick="connectToFriend()">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø</button>
        <button class="btn" style="background:#333" onclick="showScreen('menu')">–ù–ê–ó–ê–î</button>
    </div>

    <div id="weapon-menu" class="overlay">
        <h2>–í–´–ë–ï–†–ò–¢–ï –û–†–£–ñ–ò–ï</h2>
        <button id="wep0" class="btn btn-weapon selected-wep" onclick="selectWeapon(0)">–ü–ò–°–¢–û–õ–ï–¢</button>
        <button id="wep1" class="btn btn-weapon" onclick="selectWeapon(1)">–î–†–û–ë–û–í–ò–ö</button>
        <button id="wep2" class="btn btn-weapon" onclick="selectWeapon(2)">–ê–í–¢–û–ú–ê–¢</button>
        <button class="btn" onclick="showScreen('controls-pc')">–ü–ö</button>
        <button class="btn" onclick="showScreen('controls-mobile')">–¢–ï–õ–ï–§–û–ù</button>
    </div>

    <div id="controls-pc" class="overlay">
        <h2>–£–ü–†–ê–í–õ–ï–ù–ò–ï (–ü–ö)</h2>
        <p>WASD - –î–≤–∏–∂–µ–Ω–∏–µ, –ú—ã—à—å - –û–≥–æ–Ω—å, R - –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞, Esc - –ü–∞—É–∑–∞</p>
        <button class="btn" onclick="startGame('pc')">–í –ë–û–ô!</button>
    </div>

    <div id="controls-mobile" class="overlay">
        <h2>–£–ü–†–ê–í–õ–ï–ù–ò–ï (MOBILE)</h2>
        <p>–õ–µ–≤—ã–π —Å—Ç–∏–∫ - –•–æ–¥—å–±–∞, –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –û–±–∑–æ—Ä</p>
        <button class="btn" onclick="startGame('mobile')">–í –ë–û–ô!</button>
    </div>

    <div id="achievements-menu" class="overlay">
        <h2>–î–û–°–¢–ò–ñ–ï–ù–ò–Ø</h2>
        <div id="ach-container" style="text-align: left; width: 90%; max-width: 500px; margin-bottom: 20px; overflow-y: auto; max-height: 65vh; background: #111; padding: 10px; border: 1px solid #444;"></div>
        <button class="btn" onclick="showScreen('menu')">–í –ú–ï–ù–Æ</button>
    </div>

    <div id="game-over" class="overlay" style="background: rgba(50, 0, 0, 0.9);"><h1>–¢–´ –ü–û–ì–ò–ë</h1><button class="btn" onclick="location.reload()">–í –ú–ï–ù–Æ</button></div>
    <div id="victory-screen" class="overlay" style="background: rgba(0, 50, 0, 0.9);"><h1 id="victory-text">–≠–¢–ê–ñ –ó–ê–ß–ò–©–ï–ù!</h1><button class="btn" onclick="nextLevel()">–°–õ–ï–î–£–Æ–©–ò–ô –≠–¢–ê–ñ</button></div>

    <div id="joystick-container"><div id="joystick-stick"></div></div>
    <div id="shoot-btn">üî•</div>
    <div id="reload-btn">üîÑ</div>
    <div id="mobile-menu-btn" onclick="pauseGame()">ESC</div>

    <canvas id="screen"></canvas>
    <div id="crosshair">+</div>
    <div id="ui">
        <div id="level-display" style="color: yellow; font-weight: bold;">LEVEL: 1</div>
        <div id="timer-display">TIME: 03:00</div>
        <div id="health-bar"><div id="health-fill"></div></div>
        <div id="ammo-display">AMMO: 10/60 | KILLS: 0/15</div>
    </div>

    <script>
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const screenWidth = 320, screenHeight = 200;
        canvas.width = screenWidth; canvas.height = screenHeight;

        const furrySprite = new Image();
        furrySprite.src = 'furry.jpg';

        let settings = { sensitivity: 1.0, volume: 0.5 };
        
        let achievements = {};
        function initAchievements() {
            const types = [
                {id: 'kill', n: '–û—Ö–æ—Ç–Ω–∏–∫', icon: 'üíÄ', goals: [1,5,10,20,50,100,200,500,1000,5000]},
                {id: 'win', n: '–ì–µ—Ä–æ–π', icon: 'üéñÔ∏è', goals: [1,2,3,4,5,10,15,20,25,50]},
                {id: 'shot', n: '–°—Ç—Ä–µ–ª–æ–∫', icon: 'üéØ', goals: [10,50,100,200,300,400,500,1000,2000,5000]},
                {id: 'heal', n: '–ñ–∏–≤—á–∏–∫', icon: 'üíä', goals: [1,5,10,20,30,40,50,60,70,100]},
                {id: 'ammo', n: '–°–Ω–∞–±–∂–µ–Ω–µ—Ü', icon: 'üì¶', goals: [1,5,10,20,30,40,50,60,70,100]},
                {id: 'time', n: '–í–µ—Ç–µ—Ä–∞–Ω', icon: '‚è≥', goals: [60,180,300,600,1200,1800,3600,7200,14400,86400]},
                {id: 'die', n: '–°–º–µ—Ä—Ç–Ω–∏–∫', icon: '‚ö∞Ô∏è', goals: [1,5,10,15,20,25,30,40,50,100]},
                {id: 'reload', n: '–õ–æ–≤–∫–∞—á', icon: '‚ôªÔ∏è', goals: [5,10,20,30,40,50,100,150,200,500]},
                {id: 'multi', n: '–°–µ—Ç–µ–≤–∏–∫', icon: 'üåê', goals: [1,2,3,4,5,6,7,8,9,10]},
                {id: 'streak', n: '–ë–µ—Ä—Å–µ—Ä–∫', icon: 'üî•', goals: [3,5,7,10,12,15,17,20,25,30]}
            ];
            types.forEach(t => {
                t.goals.forEach((g, i) => {
                    achievements[`${t.id}_${i}`] = { 
                        name: `${t.n} LVL ${i+1}`, 
                        goal: g, current: 0, unlocked: false, icon: t.icon, 
                        desc: `–ù—É–∂–Ω–æ: ${g}` 
                    };
                });
            });
        }
        initAchievements();

        function trackAch(id, val, set=false) {
            for(let i=0; i<10; i++) {
                let a = achievements[`${id}_${i}`]; if(!a || a.unlocked) continue;
                if(set) a.current = val; else a.current += val;
                if(a.current >= a.goal) { a.unlocked = true; showAchPop(a); saveAch(); }
            }
        }
        function saveAch() { localStorage.setItem('furry_ach', JSON.stringify(achievements)); }
        function loadAch() { 
            const s = localStorage.getItem('furry_ach'); 
            if(s) { 
                const data = JSON.parse(s);
                for(let k in data) if(achievements[k]) achievements[k] = data[k];
            }
        }
        loadAch();

        function showAchPop(a) {
            const n = document.getElementById('ach-notification');
            n.innerHTML = `${a.icon} –î–û–°–¢–ò–ñ–ï–ù–ò–ï: ${a.name}`;
            n.style.display = 'block'; setTimeout(() => n.style.display='none', 3000);
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (settings.volume <= 0) return;
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain(), now = audioCtx.currentTime;
            if(type==='shoot') {
                osc.type = currentWepIdx === 1 ? 'sawtooth' : 'square';
                osc.frequency.setValueAtTime(currentWepIdx === 1 ? 150 : 400, now);
                osc.frequency.exponentialRampToValueAtTime(40, now + 0.1);
                gain.gain.setValueAtTime(0.2 * settings.volume, now);
            } else if(type==='reload') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now);
                gain.gain.setValueAtTime(0.1 * settings.volume, now);
            } else if(type==='hurt') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now);
                gain.gain.setValueAtTime(0.3 * settings.volume, now);
            }
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(now + 0.2);
        }

        let peer, conn, otherPlayer = { x: 0, y: 0, active: false };
        function initMultiplayer() {
            if (peer) return;
            trackAch('multi', 1);
            try {
                peer = new Peer();
                peer.on('open', id => { document.getElementById('my-id-container').innerText = "ID: " + id; });
                peer.on('connection', c => { conn = c; setupConn(); });
            } catch(e) { console.error("PeerJS error"); }
        }
        function connectToFriend() { const id = document.getElementById('remote-id').value; if(id) { conn = peer.connect(id); setupConn(); } }
        function setupConn() { conn.on('data', d => { if(d.type==='pos') { otherPlayer.x=d.x; otherPlayer.y=d.y; otherPlayer.active=true; } }); }

        const map = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,2,0,0,1,0,2,0,2,0,1,1,0,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1],
            [1,0,1,1,1,1,0,1,0,1,1,0,1,1,1,1,0,1,0,1],
            [1,0,2,0,0,0,0,1,0,0,0,0,0,0,2,0,0,0,0,1],
            [1,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,1,1,0,1],
            [1,0,1,0,1,0,0,0,0,0,0,1,0,1,1,0,1,0,0,1],
            [1,0,0,0,1,0,2,0,2,0,0,1,0,0,0,0,1,0,2,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];
        const mapW = map[0].length, mapH = map.length;

        const weaponTypes = [
            { clip: 10, res: 60, spread: 0.1, auto: false },
            { clip: 4, res: 24, spread: 0.4, auto: false },
            { clip: 30, res: 90, spread: 0.15, auto: true }
        ];

        let currentWepIdx = 0, ammo = 10, reserveAmmo = 60, player = { x: 2, y: 2, dir: 0, health: 100 };
        let gameRunning = false, isMobile = false, enemiesKilled = 0, timeLeft = 180, flash = 0, currentLevel = 1;
        let enemies = [], items = [], keys = {}, lastTouchX = null, joyPos = { x: 0, y: 0 }, lastShotTime = 0;

        function startGame(mode) {
            isMobile = mode === 'mobile'; showScreen('none');
            player = { x: 2, y: 2, dir: 0, health: 100 };
            enemies = []; items = []; enemiesKilled = 0; timeLeft = 180; currentLevel = 1;
            if(isMobile) {
                document.getElementById('joystick-container').style.display = 'block';
                ['shoot-btn','reload-btn','mobile-menu-btn'].forEach(id=>document.getElementById(id).style.display='flex');
                setupMobileControls();
            } else canvas.requestPointerLock();
            gameRunning = true; document.getElementById('resume-btn').style.display = 'inline-block';
            updateUI();
            requestAnimationFrame(loop);
        }

        function pauseGame() { gameRunning = false; showScreen('menu'); if(document.pointerLockElement) document.exitPointerLock(); }
        function resumeGame() { showScreen('none'); gameRunning = true; if(!isMobile) canvas.requestPointerLock(); }

        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
        function nextLevel() {
            currentLevel++;
            enemiesKilled = 0;
            timeLeft += 60; // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è
            player.health = Math.min(100, player.health + 30); // –•–∏–ª–ª–∏–º –∏–≥—Ä–æ–∫–∞
            enemies = []; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Ä–∞–≥–æ–≤
            items = []; // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã
            player.x = 2; player.y = 2; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ —Å—Ç–∞—Ä—Ç
            showScreen('none');
            gameRunning = true;
            if(!isMobile) canvas.requestPointerLock();
            updateUI();
        }

        function shoot() {
            const wep = weaponTypes[currentWepIdx];
            if (ammo <= 0 || Date.now() - lastShotTime < (wep.auto ? 100 : 300)) return;
            playSfx('shoot'); ammo--; flash = 3; lastShotTime = Date.now(); 
            trackAch('shot', 1);

            let nearestEnemy = null;
            let minDist = 10;

            enemies.forEach(en => {
                if (!en.alive) return;
                let ang = Math.atan2(en.y - player.y, en.x - player.x) - player.dir;
                while (ang < -Math.PI) ang += Math.PI * 2; 
                while (ang > Math.PI) ang -= Math.PI * 2;
                let dist = Math.hypot(en.x - player.x, en.y - player.y);
                
                if (Math.abs(ang) < wep.spread && dist < minDist) {
                    nearestEnemy = en;
                    minDist = dist;
                }
            });

            if (nearestEnemy) {
                nearestEnemy.alive = false; 
                enemiesKilled++; 
                trackAch('kill', 1);
                trackAch('streak', 1);
                if (Math.random() > 0.6) {
                    items.push({x: nearestEnemy.x, y: nearestEnemy.y, type: Math.random() > 0.5 ? 'ammo' : 'medkit'});
                }
            }
            updateUI();
        }

        function reload() {
            let take = Math.min(weaponTypes[currentWepIdx].clip - ammo, reserveAmmo);
            if(take > 0) { 
                ammo += take; reserveAmmo -= take; playSfx('reload'); updateUI(); 
                trackAch('reload', 1);
            }
        }

        function update() {
            if (!gameRunning) return;
            if (conn && conn.open) conn.send({ type: 'pos', x: player.x, y: player.y });
            timeLeft -= 1/60;
            trackAch('time', 1/60);

            let mx = 0, my = 0;
            if (isMobile) {
                mx = (-joyPos.y * Math.cos(player.dir) + joyPos.x * Math.cos(player.dir + 1.57)) * 0.1;
                my = (-joyPos.y * Math.sin(player.dir) + joyPos.x * Math.sin(player.dir + 1.57)) * 0.1;
            } else {
                if (keys['KeyW']) { mx += Math.cos(player.dir) * 0.1; my += Math.sin(player.dir) * 0.1; }
                if (keys['KeyS']) { mx -= Math.cos(player.dir) * 0.1; my -= Math.sin(player.dir) * 0.1; }
                if (keys['KeyA']) { mx += Math.cos(player.dir - 1.57) * 0.1; my += Math.sin(player.dir - 1.57) * 0.1; }
                if (keys['KeyD']) { mx += Math.cos(player.dir + 1.57) * 0.1; my += Math.sin(player.dir + 1.57) * 0.1; }
            }
            if (map[Math.floor(player.y)][Math.floor(player.x + mx * 2)] === 0) player.x += mx;
            if (map[Math.floor(player.y + my * 2)][Math.floor(player.x)] === 0) player.y += my;

            items.forEach((it, i) => {
                if (!it.collected && Math.hypot(it.x - player.x, it.y - player.y) < 0.5) {
                    it.collected = true;
                    if (it.type === 'medkit') { player.health = Math.min(100, player.health + 20); trackAch('heal', 1); }
                    else { reserveAmmo += 20; trackAch('ammo', 1); }
                    updateUI();
                }
            });

            enemies.forEach(en => {
                if (!en.alive) return;
                let d = Math.hypot(player.x - en.x, player.y - en.y);
                if (d < 0.5) { player.health -= 0.5; if(Math.random()<0.1) playSfx('hurt'); }
                else if (d < 7) { en.x += (player.x - en.x)/d * 0.03; en.y += (player.y - en.y)/d * 0.03; }
            });

            // –°–ø–∞–≤–Ω –≤—Ä–∞–≥–æ–≤ —á—É—Ç—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–µ–µ —Å –∫–∞–∂–¥—ã–º —É—Ä–æ–≤–Ω–µ–º
            if (Math.random() < (0.02 + currentLevel * 0.005) && enemies.filter(e=>e.alive).length < 8) {
                let rx = Math.random()*(mapW-2)+1, ry = Math.random()*(mapH-2)+1;
                if(map[Math.floor(ry)][Math.floor(rx)] === 0) enemies.push({x:rx, y:ry, alive:true});
            }

            if(flash > 0) flash--;
            if(player.health <= 0 || timeLeft <= 0) { 
                gameRunning = false; trackAch('die', 1); trackAch('streak', 0, true); showScreen('game-over'); 
            }
            if(enemiesKilled >= 15) { 
                gameRunning = false; trackAch('win', 1); 
                document.getElementById('victory-text').innerText = `–≠–¢–ê–ñ ${currentLevel} –ó–ê–ß–ò–©–ï–ù!`;
                showScreen('victory-screen'); 
                if(document.pointerLockElement) document.exitPointerLock();
            }
            if(!isMobile && keys['Space']) shoot();
            if(isMobile && joyPos.shooting) shoot();
        }

        function draw() {
            ctx.fillStyle = "#200"; ctx.fillRect(0,0,screenWidth,screenHeight/2);
            ctx.fillStyle = "#111"; ctx.fillRect(0,screenHeight/2,screenWidth,screenHeight/2);
            let zBuf = new Array(screenWidth);
            for (let i = 0; i < screenWidth; i++) {
                let ang = (player.dir - 0.5) + (i / screenWidth), d = 0, hit = 0;
                while (hit === 0 && d < 15) {
                    d += 0.05;
                    let tx = Math.floor(player.x + Math.cos(ang)*d), ty = Math.floor(player.y + Math.sin(ang)*d);
                    if (tx < 0 || tx >= mapW || ty < 0 || ty >= mapH) hit = 1; else hit = map[ty][tx];
                }
                zBuf[i] = d;
                let h = screenHeight / (d * Math.cos(ang-player.dir)), c = 150 / (1 + d*0.2);
                ctx.fillStyle = hit === 1 ? `rgb(${c},0,0)` : `rgb(0,0,${c})`;
                ctx.fillRect(i, screenHeight/2 - h/2, 1, h);
            }
            
            let sprites = [];
            enemies.forEach(e => { if(e.alive) sprites.push({x:e.x, y:e.y, type:'en'})});
            items.forEach(it => { if(!it.collected) sprites.push({x:it.x, y:it.y, type:it.type})});
            if(otherPlayer.active) sprites.push({x:otherPlayer.x, y:otherPlayer.y, type:'p2'});
            
            sprites.sort((a,b)=>Math.hypot(b.x-player.x, b.y-player.y)-Math.hypot(a.x-player.x, a.y-player.y));
            sprites.forEach(s => {
                let dx = s.x - player.x, dy = s.y - player.y, dist = Math.hypot(dx,dy);
                let ang = Math.atan2(dy, dx) - player.dir;
                while(ang < -Math.PI) ang += Math.PI*2; while(ang > Math.PI) ang -= Math.PI*2;
                if(Math.abs(ang) < 1 && dist > 0.3) {
                    let sx = (ang + 0.5) * screenWidth, h = screenHeight/dist, w = h;
                    if(zBuf[Math.floor(sx)] > dist) {
                        if(s.type === 'en') {
                             ctx.drawImage(furrySprite, sx - w/2, screenHeight/2 - h/2, w, h);
                        } else {
                             ctx.fillStyle = s.type === 'p2' ? 'blue' : 'yellow';
                             ctx.fillRect(sx - w/4, screenHeight/2, w/2, h/2);
                        }
                    }
                }
            });
            if(flash > 0) { ctx.fillStyle = `rgba(255,255,255,${flash*0.2})`; ctx.fillRect(0,0,screenWidth,screenHeight); }
        }

        function showScreen(id) {
            document.querySelectorAll('.overlay').forEach(s => s.style.display = 'none');
            if(id !== 'none') document.getElementById(id).style.display = 'flex';
        }

        function selectWeapon(idx) {
            currentWepIdx = idx; ammo = weaponTypes[idx].clip; reserveAmmo = weaponTypes[idx].res;
            document.querySelectorAll('.btn-weapon').forEach((b, i) => b.classList.toggle('selected-wep', i === idx));
        }

        function updateUI() {
            document.getElementById('ammo-display').innerText = `AMMO: ${ammo}/${reserveAmmo} | KILLS: ${enemiesKilled}/15`;
            document.getElementById('health-fill').style.width = player.health + "%";
            document.getElementById('level-display').innerText = `LEVEL: ${currentLevel}`;
            let m = Math.floor(timeLeft/60), s = Math.floor(timeLeft%60);
            document.getElementById('timer-display').innerText = `TIME: ${m}:${s<10?'0'+s:s}`;
        }

        function setupMobileControls() {
            const joy = document.getElementById('joystick-container'), stick = document.getElementById('joystick-stick');
            window.addEventListener('touchstart', e => { for(let t of e.changedTouches) if(t.clientX > window.innerWidth/2) lastTouchX = t.clientX; });
            window.addEventListener('touchmove', e => {
                e.preventDefault();
                for(let t of e.touches) {
                    if(t.clientX < window.innerWidth/2) {
                        let r = joy.getBoundingClientRect(), dx = t.clientX-(r.left+r.width/2), dy = t.clientY-(r.top+r.height/2);
                        let d = Math.min(60, Math.hypot(dx,dy)), ang = Math.atan2(dy,dx);
                        joyPos.x = (Math.cos(ang)*d)/60; joyPos.y = (Math.sin(ang)*d)/60;
                        stick.style.transform = `translate(calc(-50% + ${joyPos.x*60}px), calc(-50% + ${joyPos.y*60}px))`;
                    } else if(lastTouchX !== null) { player.dir += (t.clientX - lastTouchX) * 0.005 * settings.sensitivity; lastTouchX = t.clientX; }
                }
            }, {passive:false});
            window.addEventListener('touchend', () => { joyPos = {x:0,y:0}; stick.style.transform='translate(-50%,-50%)'; lastTouchX=null; });
            document.getElementById('shoot-btn').ontouchstart = () => { joyPos.shooting = true; shoot(); };
            document.getElementById('shoot-btn').ontouchend = () => { joyPos.shooting = false; };
            document.getElementById('reload-btn').onclick = reload;
        }

        function toggleAchievements(show) {
            if(show) {
                showScreen('achievements-menu'); const cont = document.getElementById('ach-container'); cont.innerHTML = '';
                let list = Object.values(achievements);
                list.forEach(a => {
                    cont.innerHTML += `<div style="padding:8px; border-bottom:1px solid #222; color:${a.unlocked?'#0f0':'#555'}">
                        ${a.icon} <b>${a.name}</b><br><small>${a.desc} (${Math.floor(a.current)}/${a.goal})</small>
                    </div>`;
                });
            } else showScreen('menu');
        }

        window.addEventListener('keydown', e => { keys[e.code] = true; if(e.code==='KeyR') reload(); if(e.code==='Escape') pauseGame(); });
        window.addEventListener('keyup', e => keys[e.code] = false);
        window.addEventListener('mousemove', e => { if(document.pointerLockElement) player.dir += e.movementX * 0.002 * settings.sensitivity; });
        window.addEventListener('mousedown', () => { if(gameRunning && !isMobile) shoot(); });

        function loop() { update(); draw(); requestAnimationFrame(loop); }
    </script>
</body>
</html>
